<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aurelo Lora — In‑Browser Data Annotator (Single File)</title>
<style>
  :root{
    --bg:#0b0f17;--panel:#111726;--muted:#6b7a90;--text:#e8eef7;--accent:#7c5cff;--accent2:#21d4fd;--good:#18c964;--bad:#ff4d67;--warn:#ffb020;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at 20% -20%, rgba(124,92,255,.15), transparent),linear-gradient(180deg,#0b0f17,#0a0e15 60%);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
  header{position:sticky;top:0;background:rgba(11,15,23,.7);backdrop-filter:blur(10px);border-bottom:1px solid #1b2238;z-index:50}
  .container{max-width:1100px;margin:0 auto;padding:24px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:36px;height:36px;border-radius:12px;background:conic-gradient(from 210deg,var(--accent),var(--accent2));box-shadow:0 0 0 4px rgba(124,92,255,.15)}
  h1{font-size:20px;margin:0}
  .sub{color:var(--muted)}
  main{padding:24px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid #1a2136;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .card h2{margin:0 0 8px;font-size:16px}
  .muted{color:var(--muted)}
  .drop{border:1.5px dashed #2a3557;border-radius:14px;padding:18px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;background:rgba(124,92,255,.06)}
  .drop:hover{background:rgba(124,92,255,.1)}
  input[type=file]{display:none}
  .btn{appearance:none;border:1px solid #2a3557;color:#e8eef7;background:#141c2e;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s ease;}
  .btn:hover{transform:translateY(-1px);border-color:#3a4a77}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#5aa9ff);border:none}
  .btn.ghost{background:transparent;border:1px dashed #2a3557}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .kv{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  textarea, select, input[type=number]{width:100%;background:#0f1524;border:1px solid #263255;border-radius:12px;color:#dfe7fb;padding:10px}
  textarea{min-height:110px}
  .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 9px;border-radius:999px;border:1px solid #2a3557;background:#121a2c;color:#bcd0f5}
  .pill.good{border-color:rgba(24,201,100,.4);background:rgba(24,201,100,.08);color:#b6f5cf}
  .pill.warn{border-color:rgba(255,176,32,.4);background:rgba(255,176,32,.08);color:#ffe0a6}
  .pill.bad{border-color:rgba(255,77,103,.35);background:rgba(255,77,103,.07);color:#ffc4cf}
  .progress{height:10px;border-radius:999px;background:#121a2c;border:1px solid #263255;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .15s}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid #20294a;padding:8px 10px;text-align:left}
  th{color:#bcd0f5;position:sticky;top:0;background:#0f1524}
  .footer{opacity:.8;margin-top:26px}
  .badge{font-size:11px;padding:4px 6px;border-radius:8px;background:#0f1524;border:1px solid #2b375e;color:#9fb6e5}
</style>
</head>
<body>
  <header>
    <div class="container brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Aurelo Lora — In‑Browser Data Annotator</h1>
        <div class="sub">Massively parallel, SLM‑style labeling — entirely client‑side, single HTML file.</div>
      </div>
    </div>
  </header>
  <main class="container">
    <div class="grid">
      <!-- Left: Data + Controls -->
      <section class="card">
        <h2>1) Load your dataset</h2>
        <label class="drop" id="dropzone">
          <strong>Drop .csv / .json / .jsonl here</strong>
          <span class="muted">or click to browse</span>
          <input id="file" type="file" accept=".csv,.json,.jsonl" />
        </label>
        <div class="row" style="margin-top:10px">
          <button id="sampleBtn" class="btn ghost">Load sample retail.csv</button>
          <span id="fileInfo" class="pill">No file loaded</span>
        </div>
        <hr style="border:none;border-top:1px solid #1a2136;margin:16px 0">
        <h2>2) Configure labeling</h2>
        <div class="kv">
          <label>
            <div class="muted">Parallel SLMs (workers)</div>
            <input type="number" id="workers" min="1" value="6" />
          </label>
          <label>
            <div class="muted">Output format</div>
            <select id="format">
              <option value="jsonl" selected>JSONL (recommended)</option>
              <option value="csv">CSV</option>
            </select>
          </label>
          <label>
            <div class="muted">Include original columns</div>
            <select id="includeOrig">
              <option value="yes" selected>Yes</option>
              <option value="no">No (annotations only)</option>
            </select>
          </label>
        </div>
        <div style="margin-top:10px">
          <div class="muted">Optional taxonomy (category: comma,separated,keywords). One per line.</div>
          <textarea id="taxonomy" placeholder="fraud: chargeback,dispute,stolen
support: ticket,refund,agent
loyalty: reward,member,points"></textarea>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="process" class="btn primary">Run Aurelo Lora Labeling</button>
          <span class="pill warn">All processing runs locally in your browser</span>
        </div>
        <div class="progress" style="margin:14px 0 6px"><div class="bar" id="bar"></div></div>
        <div class="row" style="gap:8px">
          <span id="status" class="muted">Idle.</span>
          <span id="stats" class="badge" style="display:none"></span>
        </div>
      </section>

      <!-- Right: Preview + Export -->
      <section class="card">
        <h2>3) Preview & Export</h2>
        <div class="row" style="margin-bottom:8px">
          <button id="download" class="btn" disabled>Download labeled data</button>
          <button id="clear" class="btn ghost">Clear</button>
        </div>
        <div id="previewWrap" style="max-height:420px;overflow:auto;border:1px solid #1a2136;border-radius:12px">
          <table id="preview"><thead></thead><tbody></tbody></table>
        </div>
        <div class="footer muted">
          <p>Annotations include entity extraction (email, phone, dates, currency, URLs), PII flags, token counts, naive sentiment, and optional keyword‑based categories. 
          This is a front‑end demonstration of the <strong>Aurelo Lora</strong> SLM parallelization model; swap in your own model logic server‑side for production.</p>
        </div>
      </section>
    </div>
  </main>

<script>
// =============== Utility ===============
const $ = (s)=>document.querySelector(s);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

function parseCSV(text){
  // Simple CSV parser supporting quoted fields
  const rows=[]; let i=0, cur='', row=[], q=false;
  for(const ch of text){
    if(ch==='"') { q=!q; cur+=ch; continue; }
    if(!q && ch===','){ row.push(cur.replace(/^"|"$/g,'')); cur=''; continue; }
    if(!q && (ch==='\n' || ch==='\r')){ if(cur!==''||row.length){ row.push(cur.replace(/^"|"$/g,'')); rows.push(row); row=[]; cur=''; } continue; }
    cur+=ch;
  }
  if(cur.length||row.length) rows.push([...row, cur.replace(/^"|"$/g,'')]);
  if(rows.length===0) return {headers:[], records:[]};
  const headers = rows[0].map((h,i)=>h||('col_'+(i+1)));
  const records = rows.slice(1).filter(r=>r.length && r.some(x=>x&&x.trim()!==''))
    .map(r=>Object.fromEntries(headers.map((h,i)=>[h, r[i]??''])));
  return {headers, records};
}

function toCSV(rows){
  if(!rows.length) return '';
  const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))];
  const esc=(v)=>(''+(v??'')).replace(/"/g,'""');
  const lines=[headers.map(h=>'"'+esc(h)+'"').join(',')];
  for(const r of rows){
    lines.push(headers.map(h=>'"'+esc(typeof r[h]==='object'?JSON.stringify(r[h]):r[h])+'"').join(','));
  }
  return lines.join('\n');
}

// JSONL helpers
const toJSONL = rows => rows.map(o=>JSON.stringify(o)).join('\n');

function inferColumns(records){
  const keys = new Set(); records.slice(0,50).forEach(r=>Object.keys(r).forEach(k=>keys.add(k)));
  return [...keys];
}

// ======= Simple SLM-like annotator (regex + heuristics) =======
function buildTaxonomy(mapText){
  const map={};
  mapText.split(/\n+/).forEach(line=>{
    const [cat, rest] = line.split(':');
    if(!cat||!rest) return; map[cat.trim()] = rest.split(',').map(s=>s.trim()).filter(Boolean);
  });
  return map;
}

function annotateRecord(record, taxonomy){
  const entityPatterns = {
    email: /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi,
    phone: /\b(?:\+?\d[\s.-]?)?(?:\(\d{3}\)|\d{3})[\s.-]?\d{3}[\s.-]?\d{4}\b/g,
    date: /\b(?:\d{4}-\d{2}-\d{2}|\d{1,2}[\/.-]\d{1,2}[\/.-]\d{2,4}|\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{1,2},?\s+\d{2,4})\b/gi,
    money: /(?:[$€£]|USD|EUR|GBP)\s?\d{1,3}(?:[,\s]\d{3})*(?:\.\d+)?/gi,
    url: /https?:\/\/[\w.-]+(?:\/[\w\-.~:/?#[\]@!$&'()*+,;=%]*)?/gi
  };
  const fields = Object.keys(record);
  const perField = {};
  const allText = fields.map(k=> String(record[k] ?? '')).join(' ');
  const entities = [];
  const pushEnt = (type, value, field)=>{ entities.push({type, value, field}); };
  for(const f of fields){
    const v = String(record[f] ?? '');
    const found = {};
    for(const [type, rx] of Object.entries(entityPatterns)){
      const matches = v.match(rx); if(matches){ found[type]=matches; matches.forEach(m=>pushEnt(type,m,f)); }
    }
    perField[f] = found;
  }
  // Naive sentiment
  const pos=['good','great','love','excellent','fast','happy','profit','gain','growth'];
  const neg=['bad','slow','hate','terrible','angry','bug','loss','down','delay'];
  const lower = allText.toLowerCase();
  const score = pos.reduce((a,w)=>a+(lower.includes(w)?1:0),0) - neg.reduce((a,w)=>a+(lower.includes(w)?1:0),0);

  // Categories via taxonomy
  const categories = [];
  for(const [cat, kws] of Object.entries(taxonomy)){
    if(kws.some(k=> lower.includes(k.toLowerCase()))) categories.push(cat);
  }
  const pii = entities.some(e=> e.type==='email' || e.type==='phone');
  const tokens = allText.split(/\s+/).filter(Boolean).length;

  return { entities, perField, sentiment: score, categories, pii, tokens };
}

// ======= Worker (SLM) code as Blob =======
const workerCode = `
self.onmessage = (ev)=>{
  const {chunk, taxonomy} = ev.data;
  const entityPatterns = {
    email: /\\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}\\b/gi,
    phone: /\\b(?:\\+?\\d[\\s.-]?)?(?:\\(\\d{3}\\)|\\d{3})[\\s.-]?\\d{3}[\\s.-]?\\d{4}\\b/g,
    date: /\\b(?:\\d{4}-\\d{2}-\\d{2}|\\d{1,2}[\\/.-]\\d{1,2}[\\/.-]\\d{2,4}|\\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\\s+\\d{1,2},?\\s+\\d{2,4})\\b/gi,
    money: /(?:[$€£]|USD|EUR|GBP)\\s?\\d{1,3}(?:[,\\s]\\d{3})*(?:\\.\\d+)?/gi,
    url: /https?:\\/\\/[\\w.-]+(?:\\/[\\w\\-.~:/?#[\\]@!$&'()*+,;=%]*)?/gi
  };
  function annotateRecord(record){
    const fields = Object.keys(record);
    const entities=[]; const perField={};
    const pushEnt=(type,value,field)=>entities.push({type,value,field});
    let all='';
    for(const f of fields){
      const v = String(record[f] ?? ''); all += ' '+v;
      const found={};
      for(const [type,rxs] of Object.entries(entityPatterns)){
        const matches = v.match(rxs); if(matches){ found[type]=matches; matches.forEach(m=>pushEnt(type,m,f)); }
      }
      perField[f]=found;
    }
    const low = all.toLowerCase();
    const pos=['good','great','love','excellent','fast','happy','profit','gain','growth'];
    const neg=['bad','slow','hate','terrible','angry','bug','loss','down','delay'];
    const score = pos.reduce((a,w)=>a+(low.includes(w)?1:0),0) - neg.reduce((a,w)=>a+(low.includes(w)?1:0),0);
    const categories=[];
    for(const [cat,kws] of Object.entries(taxonomy)){
      if(kws.some(k=> low.includes(k.toLowerCase()))) categories.push(cat);
    }
    const pii = entities.some(e=> e.type==='email' || e.type==='phone');
    const tokens = all.split(/\s+/).filter(Boolean).length;
    return {entities, perField, sentiment:score, categories, pii, tokens};
  }
  const out = chunk.map(row=>({ __aurelo_lora: annotateRecord(row), ...row }));
  postMessage(out);
};`;
const workerURL = URL.createObjectURL(new Blob([workerCode], {type:'text/javascript'}));

// =============== State ===============
let dataset = {headers:[], records:[]};
let labeled = [];

// =============== IO Handlers ===============
const drop = $('#dropzone');
const fileInput = $('#file');

function setStatus(msg){ $('#status').textContent = msg; }
function setProgress(p){ $('#bar').style.width = Math.max(0,Math.min(100,p))+'%'; }

['dragenter','dragover'].forEach(evt=>drop.addEventListener(evt,e=>{ e.preventDefault(); drop.style.background='rgba(124,92,255,.12)'; }));
['dragleave','drop'].forEach(evt=>drop.addEventListener(evt,e=>{ e.preventDefault(); drop.style.background='rgba(124,92,255,.06)'; }));

drop.addEventListener('click', ()=> fileInput.click());
drop.addEventListener('drop', e=> { if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', e=> { if(e.target.files[0]) handleFile(e.target.files[0]); });

async function handleFile(file){
  $('#fileInfo').textContent = file.name + ' • ' + Math.round(file.size/1024) + ' KB';
  const text = await file.text();
  if(file.name.endsWith('.csv')){
    dataset = parseCSV(text);
  } else if(file.name.endsWith('.jsonl')){
    const lines = text.split(/\n+/).filter(Boolean).map(JSON.parse);
    const headers = inferColumns(lines);
    dataset = { headers, records: lines };
  } else if(file.name.endsWith('.json')){
    const arr = JSON.parse(text);
    const records = Array.isArray(arr) ? arr : [arr];
    dataset = { headers: inferColumns(records), records };
  } else {
    alert('Unsupported file. Use .csv, .json, or .jsonl'); return;
  }
  preview(dataset.records.slice(0,30));
  setStatus('Loaded '+dataset.records.length+' rows. Ready to process.');
}

$('#sampleBtn').addEventListener('click', ()=>{
  const csv = `order_id,customer,email,phone,amount,notes,date\n`+
              `1001,Ada Lovelace,ada@microknots.ai,919-555-1200,$149.99,Love the fast delivery!,2025-10-01\n`+
              `1002,Sam Doe,doe@example.com,919-555-2255,$89.00,Refund ticket opened,http://help.example.com\n`+
              `1003,Chris P.,,919.777.8822,$1,299.00,Chargeback dispute pending,Oct 12, 2025\n`+
              `1004,Lee,lee@store.com,,EUR 49,Delayed shipment – angry customer,2025/09/13`;
  dataset = parseCSV(csv); $('#fileInfo').textContent = 'sample_retail.csv • 4 rows';
  preview(dataset.records.slice(0,30));
  setStatus('Loaded sample (4 rows).');
});

// =============== Processing ===============
$('#process').addEventListener('click', async ()=>{
  if(!dataset.records.length){ alert('Load a dataset first.'); return; }
  const nWorkers = Math.max(1, parseInt($('#workers').value||'4',10));
  const taxonomy = buildTaxonomy($('#taxonomy').value||'');
  const includeOrig = $('#includeOrig').value==='yes';

  setStatus('Spinning up '+nWorkers+' SLMs…'); setProgress(3);
  await sleep(150);

  const size = dataset.records.length; const chunkSize = Math.ceil(size / nWorkers);
  const chunks = []; for(let i=0;i<size;i+=chunkSize) chunks.push(dataset.records.slice(i,i+chunkSize));

  labeled = []; let done=0; const workers=[];
  const started = performance.now();
  $('#stats').style.display='none';

  await Promise.all(chunks.map((chunk, idx)=> new Promise((resolve)=>{
    const w = new Worker(workerURL); workers.push(w);
    w.onmessage = (ev)=>{ labeled = labeled.concat(ev.data); done+=chunk.length; setProgress(Math.round(100*done/size)); resolve(); };
    w.postMessage({chunk, taxonomy});
  })));

  const elapsed = ((performance.now()-started)/1000).toFixed(2);
  setStatus('Labeling complete in '+elapsed+'s.');
  $('#stats').textContent = `rows: ${size} • workers: ${nWorkers} • rps: ${(size/elapsed).toFixed(1)}`;
  $('#stats').style.display='inline-block';

  // Strip originals if needed
  if(!includeOrig){ labeled = labeled.map(r=>({__aurelo_lora: r.__aurelo_lora})); }

  preview(labeled.slice(0,30));
  $('#download').disabled=false;
});

$('#download').addEventListener('click', ()=>{
  const fmt = $('#format').value;
  const data = fmt==='csv' ? toCSV(labeled) : toJSONL(labeled);
  const blob = new Blob([data], {type: fmt==='csv'?'text/csv':'application/x-ndjson'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'aurelo_lora_labeled.'+(fmt==='csv'?'csv':'jsonl');
  document.body.appendChild(a); a.click(); a.remove();
});

$('#clear').addEventListener('click', ()=>{
  dataset={headers:[],records:[]}; labeled=[]; $('#preview thead').innerHTML=''; $('#preview tbody').innerHTML='';
  $('#download').disabled=true; setProgress(0); setStatus('Cleared.'); $('#fileInfo').textContent='No file loaded';
});

// =============== Preview Table ===============
function preview(rows){
  const table=$('#preview'); const thead=table.querySelector('thead'); const tbody=table.querySelector('tbody');
  thead.innerHTML=''; tbody.innerHTML='';
  if(!rows.length){ tbody.innerHTML = '<tr><td class="muted">No rows</td></tr>'; return; }
  const cols = [...new Set(rows.flatMap(r=>Object.keys(r)))];
  const tr = document.createElement('tr'); cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; tr.appendChild(th); }); thead.appendChild(tr);
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    cols.forEach(c=>{
      const td=document.createElement('td');
      const v=r[c];
      td.textContent = typeof v==='object'? JSON.stringify(v) : (v??'');
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>
