<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aurelo Bay ‚Äî Enterprise Ops (USD)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#071027; --panel:#0f1724; --muted:#93a8bf; --accent:#60a5fa; --glass:rgba(255,255,255,0.04);
  --card:#0b1220; --text:#e6eef8; --text-muted:#93a8bf;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),#05111b);color:var(--text);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
.container{max-width:1600px;margin:18px auto;display:grid;grid-template-columns:280px 1fr;gap:18px;padding:12px}
aside.sidebar{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:16px;height:calc(100vh - 36px);position:sticky;top:18px;overflow:auto}
.logo{display:flex;align-items:center;gap:12px;margin-bottom:8px}
.brand-circle{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(90deg,#7c3aed,#06b6d4);font-weight:800}
.brand-title{font-weight:700;font-size:16px}
nav#mainNav{display:flex;flex-direction:column;gap:6px;margin-top:12px}
button.nav-btn{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:0;background:transparent;color:var(--text-muted);cursor:pointer;text-align:left;font-size:14px}
button.nav-btn:hover{background:var(--glass);color:#fff}
button.nav-btn.active{background:linear-gradient(90deg,rgba(99,102,241,0.12),rgba(6,182,212,0.06));color:#fff}
.sidebar .section-title{font-size:12px;color:var(--text-muted);margin-top:12px}
.pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--text-muted);font-weight:600}
.sidebar .actions{display:flex;flex-direction:column;gap:8px;margin-top:12px}
main{padding:6px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.search-box{display:flex;gap:8px;align-items:center}
input.search{padding:9px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:inherit;min-width:260px}
.btn{padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:#05203b;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.12);color:var(--text-muted)}
.grid{display:grid;gap:12px}
.cols-2{grid-template-columns:repeat(2,1fr)}
.cols-3{grid-template-columns:repeat(3,1fr)}
.cols-4{grid-template-columns:repeat(4,1fr)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.08)}
.kpi{font-size:20px;font-weight:800}
.kpi-sub{color:var(--text-muted);font-size:12px}
.muted{color:var(--text-muted);font-size:13px}
.badge{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.08);font-weight:700}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{color:var(--text-muted);text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,0.12)}
tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.06)}
.page{display:none}
.page.active{display:block}
footer{margin-top:18px;color:var(--text-muted);font-size:12px;text-align:center}
/* Light theme */
body.light{--bg:#fff; --panel:#f2f4f8; --text:#000; --text-muted:#444; --card:#fefefe; --glass:rgba(0,0,0,0.06)}
@media (max-width: 980px){.container{grid-template-columns:1fr} aside.sidebar{height:auto;position:relative}}
</style>
</head>
<body>
<div class="container">
  <!-- SIDEBAR -->
  <aside class="sidebar" aria-label="Sidebar">
    <div class="logo">
      <div class="brand-circle">AB</div>
      <div>
        <div class="brand-title">Aurelo Bay</div>
        <div class="muted" style="font-size:12px">Unified Ops & Analytics</div>
      </div>
    </div>

    <nav id="mainNav" aria-label="Primary">
      <button class="nav-btn active" data-page="overview">üè† Overview</button>
      <button class="nav-btn" data-page="sales">üßæ Sales</button>
      <button class="nav-btn" data-page="products">üõí Products</button>
      <button class="nav-btn" data-page="inventory">üì¶ Inventory</button>
      <button class="nav-btn" data-page="marketing">üì£ Marketing</button>
      <button class="nav-btn" data-page="pnl">üìä P&L</button>
      <button class="nav-btn" data-page="logistics">üöö Logistics</button>
      <button class="nav-btn" data-page="accounts">üè¶ Accounts</button>
      <button class="nav-btn" data-page="support">üéß Support</button>
      <button class="nav-btn" data-page="ai">üß† AI Search Models</button>
      <button class="nav-btn" data-page="chatbots">ü§ñ Chatbots</button>
      <button class="nav-btn" data-page="pipelines">üîó Data Pipelines</button>
      <button class="nav-btn" data-page="analytics">üìà Analytics</button>
      <button class="nav-btn" data-page="users">üë• Users</button>
      <button class="nav-btn" data-page="alerts">üö® Alerts</button>
      <button class="nav-btn" data-page="settings">‚öôÔ∏è Settings</button>
    </nav>

    <div class="section-title">Bay Area Stores</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <div class="pill">San Francisco</div>
      <div class="pill">San Jose</div>
      <div class="pill">Oakland</div>
      <div class="pill">Palo Alto</div>
      <div class="pill">Berkeley</div>
      <div class="pill">Online</div>
    </div>

    <div class="section-title">Quick actions</div>
    <div class="actions">
      <button id="exportSnapshot" class="btn">Export snapshot</button>
      <button id="toggleTheme" class="btn ghost">Toggle theme</button>
    </div>
  </aside>

  <!-- MAIN -->
  <main>
    <div class="header">
      <div class="search-box">
        <input id="globalSearch" class="search" placeholder="Search orders, SKUs, customers, accounts, tickets..." />
      </div>
      <div class="muted">Manager: Monish ‚Ä¢ Admin</div>
    </div>

    <!-- OVERVIEW -->
    <section id="overview" class="page active">
      <h2>Overview</h2>
      <div class="grid cols-4" id="kpiGrid"></div>

      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Today ‚Äî Hourly Sales</strong>
            <span class="muted" id="todayRange"></span>
          </div>
          <canvas id="hourlyChart" height="150"></canvas>
        </div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>This Week ‚Äî Daily Revenue</strong>
            <span class="muted" id="weekTotal"></span>
          </div>
          <canvas id="weeklyChart" height="150"></canvas>
        </div>
      </div>

      <div class="grid cols-3" style="margin-top:12px">
        <div class="card">
          <strong>Category Mix</strong>
          <div class="muted" style="margin:6px 0">Electronics, Home, Apparel, Sports, Grocery</div>
          <canvas id="categoryChart" height="160"></canvas>
        </div>
        <div class="card">
          <strong>Payment Mix</strong>
          <div class="muted" style="margin:6px 0">Card, Apple Pay, Google Pay, Cash</div>
          <canvas id="paymentChart" height="160"></canvas>
        </div>
        <div class="card">
          <strong>Top Products (Today)</strong>
          <div class="muted" style="margin:6px 0">Qty sold by SKU</div>
          <canvas id="topItemsChart" height="160"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Sales by City (This Month)</strong>
        <canvas id="regionStackedChart" height="150"></canvas>
      </div>
    </section>

    <!-- SALES -->
    <section id="sales" class="page">
      <h2>Orders</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
        <input id="orderSearch" class="search" style="min-width:240px" placeholder="Search order ID / email / item / city" />
        <select id="orderStore" class="btn ghost" style="padding:8px;border-radius:8px">
          <option value="">All stores</option><option>San Francisco</option><option>San Jose</option><option>Oakland</option><option>Palo Alto</option><option>Berkeley</option><option>Online</option>
        </select>
        <select id="orderPay" class="btn ghost" style="padding:8px;border-radius:8px">
          <option value="">All payment</option><option>Card</option><option>Apple Pay</option><option>Google Pay</option><option>Cash</option>
        </select>
        <button id="exportOrders" class="btn">Export CSV</button>
      </div>
      <div class="card table-wrap">
        <table id="orderTable">
          <thead>
            <tr><th>Order</th><th>Time</th><th>Store</th><th>Channel</th><th>Items</th><th>Sub-total</th><th>Tax (8.75%)</th><th>Total</th><th>Payment</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" id="orderCount" style="margin-top:8px">0 orders</div>
    </section>

    <!-- PRODUCTS -->
    <section id="products" class="page">
      <h2>Products</h2>
      <div class="grid cols-3" id="productKPIs"></div>
      <div class="card table-wrap" style="margin-top:12px">
        <table id="productTable">
          <thead><tr><th>SKU</th><th>Name</th><th>Category</th><th>Price</th><th>Units (30d)</th><th>Gross Sales</th><th>Return %</th><th>Rating</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="inventory" class="page">
      <h2>Inventory Management</h2>
      <div class="grid cols-4" id="invKPIs"></div>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <strong>Stock by Category</strong>
          <canvas id="invCatChart" height="150"></canvas>
        </div>
        <div class="card">
          <strong>Reorder Queue (Top)</strong>
          <div class="table-wrap" style="margin-top:8px">
            <table id="invReorder">
              <thead><tr><th>SKU</th><th>Name</th><th>On Hand</th><th>ROP</th><th>ETA</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <strong>Inventory Table</strong>
        <div class="table-wrap" style="margin-top:8px">
          <table id="invTable">
            <thead><tr><th>SKU</th><th>Name</th><th>On Hand</th><th>Allocated</th><th>Backorder</th><th>Turn (30d)</th><th>Shrink%</th><th>Valuation</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MARKETING -->
    <section id="marketing" class="page">
      <h2>Marketing</h2>
      <div class="grid cols-4" id="mktKPIs"></div>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <strong>Attribution (Last 30d)</strong>
          <canvas id="mktAttrChart" height="150"></canvas>
        </div>
        <div class="card">
          <strong>Campaign ROAS</strong>
          <canvas id="mktRoasChart" height="150"></canvas>
        </div>
      </div>
    </section>

    <!-- P&L -->
    <section id="pnl" class="page">
      <h2>P&L</h2>
      <div class="grid cols-4" id="pnlKPIs"></div>
      <div class="card" style="margin-top:12px">
        <strong>Monthly P&L Trend</strong>
        <canvas id="pnlChart" height="160"></canvas>
      </div>
    </section>

    <!-- LOGISTICS -->
    <section id="logistics" class="page">
      <h2>Logistics</h2>
      <div class="grid cols-4" id="logKPIs"></div>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <strong>Carrier Mix</strong>
          <canvas id="logCarrierChart" height="150"></canvas>
        </div>
        <div class="card">
          <strong>Fulfillment SLA (hrs)</strong>
          <canvas id="logSlaChart" height="150"></canvas>
        </div>
      </div>
    </section>

    <!-- ACCOUNTS -->
    <section id="accounts" class="page">
      <h2>B2B / Wholesale Accounts</h2>
      <div class="grid cols-3" id="accKPIs"></div>
      <div class="card table-wrap" style="margin-top:12px">
        <table id="accTable">
          <thead><tr><th>Account</th><th>City</th><th>Contact</th><th>Open Balance</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SUPPORT -->
    <section id="support" class="page">
      <h2>Customer Support</h2>
      <div class="grid cols-4" id="supKPIs"></div>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <strong>Tickets by Type</strong>
          <canvas id="supTypeChart" height="150"></canvas>
        </div>
        <div class="card">
          <strong>CSAT Trend</strong>
          <canvas id="supCsatChart" height="150"></canvas>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <strong>Recent Tickets</strong>
        <div class="table-wrap" style="margin-top:8px">
          <table id="supTable">
            <thead><tr><th>ID</th><th>Channel</th><th>Type</th><th>Priority</th><th>First Response</th><th>Resolution</th><th>CSAT</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- AI SEARCH MODELS -->
    <section id="ai" class="page">
      <h2>AI Search Models</h2>
      <div class="grid cols-4" id="aiKPIs"></div>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <strong>Embedding Versions (Recall@10)</strong>
          <canvas id="aiRecallChart" height="150"></canvas>
        </div>
        <div class="card">
          <strong>Latency (p50/p95 ms)</strong>
          <canvas id="aiLatencyChart" height="150"></canvas>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <strong>Offline Eval Results</strong>
        <div class="table-wrap" style="margin-top:8px">
          <table id="aiTable">
            <thead><tr><th>Model</th><th>Version</th><th>Recall@10</th><th>MRR</th><th>Latency p95</th><th>Notes</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CHATBOTS -->
    <section id="chatbots" class="page">
      <h2>Chatbots</h2>
      <div class="grid cols-4" id="botKPIs"></div>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <strong>Containment Rate</strong>
          <canvas id="botContainChart" height="150"></canvas>
        </div>
        <div class="card">
          <strong>Average Handle Time (sec)</strong>
          <canvas id="botAhtChart" height="150"></canvas>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <strong>Recent Conversations</strong>
        <div class="table-wrap" style="margin-top:8px">
          <table id="botTable">
            <thead><tr><th>Conv ID</th><th>Channel</th><th>Intent</th><th>Resolved</th><th>Handoff</th><th>CSAT</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- DATA PIPELINES -->
    <section id="pipelines" class="page">
      <h2>Data Pipelines</h2>
      <div class="grid cols-4" id="pipeKPIs"></div>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <strong>Batch Jobs (status)</strong>
          <div class="table-wrap" style="margin-top:8px">
            <table id="pipeBatch">
              <thead><tr><th>Job</th><th>Schedule</th><th>Last Run</th><th>Status</th><th>Freshness</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <strong>Streaming (throughput)</strong>
          <canvas id="pipeStreamChart" height="150"></canvas>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <strong>Data Quality (DQ) Rules</strong>
        <div class="table-wrap" style="margin-top:8px">
          <table id="pipeDQ">
            <thead><tr><th>Dataset</th><th>Rule</th><th>Pass%</th><th>Last Check</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ANALYTICS (simulator + monthly revenue already shown) -->
    <section id="analytics" class="page">
      <h2>Analytics & Simulator</h2>
      <div class="grid cols-2">
        <div class="card">
          <strong>Scenario: Promo vs Churn</strong>
          <div style="display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap">
            <label class="muted">Promo% <input id="simPromo" type="range" min="0" max="40" value="12" /></label>
            <span id="simPromoVal" class="badge">12%</span>
            <label class="muted" style="margin-left:10px">Churn% <input id="simChurn" type="range" min="0" max="15" value="3" /></label>
            <span id="simChurnVal" class="badge">3%</span>
            <label class="muted" style="margin-left:10px">New CAC ($) <input id="simCAC" type="number" value="14" style="width:70px" /></label>
            <button id="runSim" class="btn">Run</button>
          </div>
          <div class="muted" id="simResult" style="margin-top:8px">Adjust sliders and run.</div>
        </div>
        <div class="card">
          <strong>Insights</strong>
          <ul id="insightsList" class="muted" style="margin-top:6px"></ul>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <strong>Monthly Revenue (Last 12m vs Prev 12m)</strong>
        <canvas id="monthlyChart" height="160"></canvas>
      </div>
    </section>

    <!-- USERS -->
    <section id="users" class="page">
      <h2>Users</h2>
      <div class="card table-wrap">
        <table id="usersTable">
          <thead><tr><th>Name</th><th>Role</th><th>Location</th><th>Active</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ALERTS -->
    <section id="alerts" class="page">
      <h2>Alerts</h2>
      <div class="card">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label class="muted">High returns > <input id="thReturn" type="number" value="6" style="width:64px"> %</label>
          <label class="muted">Card share < input id="thCard" type="number" value="50" style="width:64px"> %</label>
          <label class="muted">AOV > < input id="thAOV" type="number" value="85" style="width:64px"> $</label>
          <button id="saveAlerts" class="btn">Save</button>
        </div>
      </div>
      <div id="alertLog" class="muted" style="margin-top:8px"></div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="page">
      <h2>Settings</h2>
      <div class="card">
        <label class="muted"><input id="prefEmail" type="checkbox" checked> Email daily summary</label>
        <div style="height:8px"></div>
        <label class="muted"><input id="prefTheme" type="checkbox"> Start in Light theme</label>
        <div style="margin-top:10px"><button id="saveSettings" class="btn">Save preferences</button></div>
      </div>
      <footer>¬© <span id="yr"></span> Aurelo Bay</footer>
    </section>
  </main>
</div>

<script>
/* -------------------------- Utilities -------------------------- */
const USD = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', maximumFractionDigits:0 });
const fmtN = n => new Intl.NumberFormat('en-US').format(n);
const byId = id => document.getElementById(id);
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const todayStr = () => new Date().toLocaleDateString('en-US',{weekday:'short', month:'short', day:'2-digit'});

/* -------------------------- Navigation + Theme -------------------------- */
$('#mainNav').addEventListener('click', e=>{
  const btn = e.target.closest('.nav-btn'); if(!btn) return;
  $$('.nav-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
  const id = btn.dataset.page; $$('.page').forEach(p=>p.classList.toggle('active', p.id===id));
  history.pushState({page:id}, '', '#'+id);
});
window.addEventListener('popstate', (e)=>{ const id = (e.state&&e.state.page)||location.hash.replace('#','')||'overview';
  $$('.nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.page===id));
  $$('.page').forEach(p=>p.classList.toggle('active', p.id===id));
});
byId('toggleTheme').addEventListener('click', ()=>{ document.body.classList.toggle('light'); localStorage.setItem('ab_theme', document.body.classList.contains('light')?'light':'dark'); });
(function(){ if(localStorage.getItem('ab_theme')==='light') document.body.classList.add('light'); })();

/* -------------------------- Core Retail Data (same base as before) -------------------------- */
const STORES = ['San Francisco','San Jose','Oakland','Palo Alto','Berkeley','Online'];
const PAY = ['Card','Apple Pay','Google Pay','Cash'];
const CHANNEL = ['In-store','Online'];
const CATEGORY = ['Electronics','Home','Apparel','Sports','Grocery'];
const TAX_RATE = 0.0875;

/* Product catalog */
const PRODUCTS = [
  ['ELEC-001','Aurelo Smart Speaker','Electronics',129],['ELEC-002','Noise-Cancel Headphones','Electronics',199],['ELEC-003','4K Streaming Stick','Electronics',59],
  ['ELEC-004','Wireless Charger','Electronics',39],['ELEC-005','USB-C Hub 8-in-1','Electronics',79],['HOME-101','LED Floor Lamp','Home',89],['HOME-102','Ergo Office Chair','Home',179],
  ['HOME-103','Bamboo Cutting Board','Home',24],['HOME-104','Aromatherapy Diffuser','Home',49],['HOME-105','Espresso Machine','Home',349],['APRL-201','Hoodie ‚Äî Unisex','Apparel',65],
  ['APRL-202','Performance Tee','Apparel',35],['APRL-203','Running Shorts','Apparel',45],['APRL-204','Windbreaker','Apparel',98],['APRL-205','Everyday Jeans','Apparel',79],
  ['SPRT-301','Yoga Mat Pro','Sports',59],['SPRT-302','Adjustable Dumbbells','Sports',229],['SPRT-303','Foam Roller','Sports',29],['SPRT-304','Cycling Helmet','Sports',85],
  ['SPRT-305','Tennis Racket','Sports',119],['GROC-401','Organic Coffee Beans (1lb)','Grocery',16],['GROC-402','Almond Butter (16oz)','Grocery',12],['GROC-403','Protein Bars (12pk)','Grocery',18],
  ['GROC-404','Sparkling Water (12pk)','Grocery',11],['GROC-405','Olive Oil (1L)','Grocery',19],['ELEC-006','Bluetooth Tracker (4-pk)','Electronics',69],['ELEC-007','Smart Bulb (2-pk)','Electronics',29],
  ['HOME-106','Air Purifier','Home',199],['HOME-107','Cast Iron Skillet','Home',44],['APRL-206','Baseball Cap','Apparel',28],['APRL-207','Sneakers','Apparel',120],
  ['SPRT-306','Fitness Band','Sports',99],['SPRT-307','Jump Rope','Sports',18],['GROC-406','Trail Mix (2lb)','Grocery',14],['GROC-407','Kombucha (6pk)','Grocery',16],
  ['ELEC-008','Portable SSD 1TB','Electronics',119],['HOME-108','Smart Thermostat','Home',229],['APRL-208','Socks (6-pk)','Apparel',22],['SPRT-308','Pickleball Set','Sports',89],
  ['GROC-408','Oat Milk (64oz)','Grocery',6]
].map(([sku,name,cat,price])=>({sku,name,cat,price}));

/* Helpers */
function pickWeighted(weights){const total=weights.reduce((a,b)=>a+b,0);let r=Math.random()*total;for(let i=0;i<weights.length;i++){if(r<weights[i])return i;r-=weights[i]}return weights.length-1;}
function makeOrder(idx){
  const store = STORES[pickWeighted([22,22,16,14,12,14])];
  const channel = CHANNEL[pickWeighted([70,30])];
  const pm = PAY[pickWeighted([55,20,10,15])];
  const itemCount = 1 + Math.floor(Math.random()*4);
  const items=[]; let subtotal=0; let qtyTotal=0;
  for(let i=0;i<itemCount;i++){
    const p = PRODUCTS[pickWeighted([8,8,7,7,7,7,6,5,5,6,7,7,6,6,6,6,5,5,5,5,5,5,5,5,5,6,6,5,5,4,5,5,4,4,4,6,5,4,4])];
    const qty = 1 + Math.floor(Math.random()*3);
    items.push({sku:p.sku, name:p.name, cat:p.cat, price:p.price, qty}); subtotal += p.price*qty; qtyTotal += qty;
  }
  const tax = Math.round(subtotal*TAX_RATE); const total=subtotal+tax;
  const now=new Date(); const hour=Math.floor(Math.random()*(now.getHours()||10)); const time=new Date(); time.setHours(hour,Math.floor(Math.random()*60),0,0);
  return {order:'AB'+String(100000+idx), time:time.toTimeString().slice(0,5), store, channel, items, qty:qtyTotal, subtotal, tax, total, pay:pm};
}
const ORDERS = Array.from({length: 880}, (_,i)=> makeOrder(i));

/* Accounts & Users (short) */
const ACCOUNTS = Array.from({length: 250}, (_,i)=>({acc:`Account ${i+1}`,city:['San Francisco','San Jose','Oakland','Palo Alto','Berkeley'][i%5],contact:`+1 (415) ${200+Math.floor(Math.random()*700)}-${String(1000+Math.floor(Math.random()*9000)).slice(-4)}`,bal:Math.round(2000+Math.random()*160000),st:['Active','Overdue','Settled'][pickWeighted([68,14,18])]}));
const USERS = [{n:'Riley Chen',role:'Store Manager',loc:'San Francisco',active:true},{n:'Jordan Patel',role:'Ops Analyst',loc:'San Jose',active:true},{n:'Avery Kim',role:'Cashier',loc:'Oakland',active:true},{n:'Sam Rivera',role:'E-Com Lead',loc:'Online',active:true},{n:'Taylor Brooks',role:'Sales Associate',loc:'Palo Alto',active:false}];

/* -------------------------- Aggregations -------------------------- */
function aggregate(){
  const gross=ORDERS.reduce((s,b)=>s+b.total,0), net=ORDERS.reduce((s,b)=>s+b.subtotal,0), tax=ORDERS.reduce((s,b)=>s+b.tax,0), orders=ORDERS.length, itemsSold=ORDERS.reduce((s,b)=>s+b.qty,0);
  const aov=Math.round(net/orders), cardShare=Math.round(ORDERS.filter(b=>b.pay==='Card').length/orders*100), appleShare=Math.round(ORDERS.filter(b=>b.pay==='Apple Pay').length/orders*100);
  const online=ORDERS.filter(b=>b.channel==='Online').length, instore=orders-online, returns=Math.round(orders*0.035), refundRate=Math.round(returns/orders*1000)/10;
  const repeatCust=Math.round(orders*0.22), newCust=orders-repeatCust, visitors=22000+Math.floor(Math.random()*7000), conversion=Math.round((orders/visitors)*1000)/10, rpv=Math.round((net/visitors)*100)/100;
  const mrr=Math.round((net*0.14)/12), cac=14+Math.round(Math.random()*8), ltv=Math.round(aov*(3+Math.random()*6));
  return {gross,net,tax,orders,aov,itemsSold,cardShare,appleShare,online,instore,returns,refundRate,repeatCust,newCust,visitors,conversion,rpv,mrr,cac,ltv};
}
const AGG = aggregate();

/* -------------------------- OVERVIEW -------------------------- */
function renderKPIs(){
  const grid=byId('kpiGrid');
  const rows=[
    {label:'Gross Sales (Today)',val:USD.format(AGG.gross),sub:'+8.2% vs yesterday'},
    {label:'Net Sales (ex-tax)',val:USD.format(AGG.net),sub:'Tax 8.75%'},
    {label:'Orders',val:fmtN(AGG.orders),sub:`In-store ${fmtN(AGG.instore)} ¬∑ Online ${fmtN(AGG.online)}`},
    {label:'Avg Order Value',val:USD.format(AGG.aov),sub:'AOV'},
    {label:'Items Sold',val:fmtN(AGG.itemsSold),sub:'Units'},
    {label:'Sales Tax',val:USD.format(AGG.tax),sub:'To remit'},
    {label:'Card Share',val:AGG.cardShare+'%',sub:'Tap-to-pay lanes'},
    {label:'Apple Pay',val:AGG.appleShare+'%',sub:'Express checkout'},
    {label:'Returns',val:fmtN(AGG.returns),sub:`Refund rate ${AGG.refundRate}%`},
    {label:'Customers',val:`${fmtN(AGG.newCust)} new / ${fmtN(AGG.repeatCust)} repeat`,sub:'~22% repeat'},
    {label:'Conversion',val:AGG.conversion+'%',sub:`Visitors ${fmtN(AGG.visitors)}`},
    {label:'RPV',val:'$'+AGG.rpv,sub:'Revenue per Visitor'},
    {label:'CAC',val:USD.format(AGG.cac),sub:'Simulated'},
    {label:'LTV',val:USD.format(AGG.ltv),sub:'Simulated'},
    {label:'MRR',val:USD.format(AGG.mrr),sub:'Subscriptions est.'},
    {label:'Top City',val:'San Francisco',sub:'by revenue'},
  ];
  grid.innerHTML=rows.map(r=>`<div class="card"><div class="kpi">${r.val}</div><div class="kpi-sub">${r.label}</div><div class="muted" style="margin-top:4px">${r.sub}</div></div>`).join('');
  byId('todayRange').textContent=todayStr();
}

/* Charts reused from earlier build */
let hourlyChart, weeklyChart, categoryChart, paymentChart, topItemsChart, regionStackedChart, monthlyChart, invCatChart, mktAttrChart, mktRoasChart, pnlChart, logCarrierChart, logSlaChart, supTypeChart, supCsatChart, aiRecallChart, aiLatencyChart, pipeStreamChart;
function buildHourly(){const hours=Array.from({length:14},(_,i)=>i+8);const vals=hours.map(h=>h>=12&&h<=14?35000+Math.random()*18000:h>=18&&h<=20?42000+Math.random()*20000:15000+Math.random()*12000);hourlyChart=new Chart(byId('hourlyChart'),{type:'line',data:{labels:hours.map(h=>`${String(h).padStart(2,'0')}:00`),datasets:[{label:'Revenue',data:vals,borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,0.18)',fill:true,tension:.3}]},options:{responsive:true,plugins:{legend:{display:false}}})}
function buildWeekly(){const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];const vals=days.map((d,i)=>(i>=4?280000:210000)+Math.random()*80000);weeklyChart=new Chart(byId('weeklyChart'),{type:'bar',data:{labels:days,datasets:[{label:'Revenue',data:vals,backgroundColor:'#60a5fa'}]},options:{responsive:true,plugins:{legend:{display:false}}}});byId('weekTotal').textContent='Week Total: '+USD.format(vals.reduce((a,b)=>a+b,0))}
function buildCategory(){const catAgg={Electronics:0,Home:0,Apparel:0,Sports:0,Grocery:0};ORDERS.forEach(o=>o.items.forEach(i=>catAgg[i.cat]+=i.price*i.qty));categoryChart=new Chart(byId('categoryChart'),{type:'doughnut',data:{labels:Object.keys(catAgg),datasets:[{data:Object.values(catAgg),backgroundColor:['#60a5fa','#7c3aed','#22c55e','#f97316','#a78bfa']}]},options:{plugins:{legend:{position:'bottom'}}}})}
function buildPayment(){const pmAgg={Card:0,'Apple Pay':0,'Google Pay':0,Cash:0};ORDERS.forEach(o=>pmAgg[o.pay]+=o.total);paymentChart=new Chart(byId('paymentChart'),{type:'doughnut',data:{labels:Object.keys(pmAgg),datasets:[{data:Object.values(pmAgg),backgroundColor:['#22c55e','#60a5fa','#a78bfa','#f59e0b']}]},options:{plugins:{legend:{position:'bottom'}}}})}
function buildTopItems(){const qtyMap={};ORDERS.forEach(o=>o.items.forEach(i=>qtyMap[i.name]=(qtyMap[i.name]||0)+i.qty));const list=Object.entries(qtyMap).sort((a,b)=>b[1]-a[1]).slice(0,8);topItemsChart=new Chart(byId('topItemsChart'),{type:'bar',data:{labels:list.map(x=>x[0]),datasets:[{label:'Units',data:list.map(x=>x[1]),backgroundColor:'#f59e0b'}]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{maxRotation:60,minRotation:0}}}})}
function buildRegionStacked(){const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];const series=STORES.slice(0,5);const agg={};series.forEach(s=>agg[s]=Array(7).fill(0));for(let i=0;i<7;i++){series.forEach((s,si)=>{agg[s][i]=50000+si*12000+i*8000+Math.random()*18000})}regionStackedChart=new Chart(byId('regionStackedChart'),{type:'bar',data:{labels:days,datasets:series.map((s,idx)=>({label:s,data:agg[s],backgroundColor:['#60a5fa','#7c3aed','#22c55e','#f97316','#e11d48'][idx%5],stack:'cities'}))},options:{responsive:true,plugins:{legend:{position:'bottom'}},scales:{x:{stacked:true},y:{stacked:true}}})}
function buildMonthly(){const months=['Oct','Nov','Dec','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep'];const thisYear=months.map((_,i)=>900000+i*38000+Math.random()*90000);const lastYear=months.map((_,i)=>740000+i*32000+Math.random()*80000);monthlyChart=new Chart(byId('monthlyChart'),{type:'line',data:{labels:months,datasets:[{label:'This Year',data:thisYear,borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,0.18)',fill:true,tension:.35},{label:'Prev Year',data:lastYear,borderColor:'#94a3b8',borderDash:[6,6],tension:.35}]},options:{responsive:true}})}

/* -------------------------- SALES TABLE -------------------------- */
function renderOrders(){const body=byId('orderTable').querySelector('tbody');body.innerHTML=ORDERS.slice(0,260).map(b=>`<tr><td>${b.order}</td><td>${b.time}</td><td>${b.store}</td><td>${b.channel}</td><td>${b.qty}</td><td>${USD.format(b.subtotal)}</td><td>${USD.format(b.tax)}</td><td><strong>${USD.format(b.total)}</strong></td><td>${b.pay}</td></tr>`).join('');byId('orderCount').textContent=`${ORDERS.length} orders (sampled ${Math.min(260,ORDERS.length)})`}
byId('orderSearch').addEventListener('input',e=>{const q=e.target.value.toLowerCase();const body=byId('orderTable').querySelector('tbody');body.innerHTML=ORDERS.filter(b=>{const hay=JSON.stringify(b).toLowerCase();return !q||hay.includes(q)}).slice(0,260).map(b=>`<tr><td>${b.order}</td><td>${b.time}</td><td>${b.store}</td><td>${b.channel}</td><td>${b.qty}</td><td>${USD.format(b.subtotal)}</td><td>${USD.format(b.tax)}</td><td><strong>${USD.format(b.total)}</strong></td><td>${b.pay}</td></tr>`).join('')})
byId('orderStore').addEventListener('change',filterOrders);byId('orderPay').addEventListener('change',filterOrders);
function filterOrders(){const s=byId('orderStore').value,p=byId('orderPay').value;const body=byId('orderTable').querySelector('tbody');body.innerHTML=ORDERS.filter(b=>(!s||b.store===s)&&(!p||b.pay===p)).slice(0,260).map(b=>`<tr><td>${b.order}</td><td>${b.time}</td><td>${b.store}</td><td>${b.channel}</td><td>${b.qty}</td><td>${USD.format(b.subtotal)}</td><td>${USD.format(b.tax)}</td><td><strong>${USD.format(b.total)}</strong></td><td>${b.pay}</td></tr>`).join('')}
byId('exportOrders').addEventListener('click',()=>{const headers=['Order','Time','Store','Channel','Items','Subtotal','Tax','Total','Payment'];const rows=ORDERS.map(b=>[b.order,b.time,b.store,b.channel,b.qty,b.subtotal,b.tax,b.total,b.pay]);const csv=[headers.join(',')].concat(rows.map(r=>r.join(','))).join('\n');const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='orders.csv';a.click();URL.revokeObjectURL(url)})

/* -------------------------- PRODUCTS PAGE -------------------------- */
function renderProducts(){const perf=PRODUCTS.map(p=>{const base={Electronics:65,Home:50,Apparel:58,Sports:46,Grocery:74}[p.cat];const units30=base+Math.floor(Math.random()*base*1.4);const gross=units30*p.price;const returnPct=(p.cat==='Apparel'?(3+Math.random()*2.5):p.cat==='Electronics'?(2+Math.random()*1.5):(1+Math.random()*1.5)).toFixed(1);const rating=(4+Math.random()).toFixed(1);return {...p,units30,gross,returnPct,rating}}).sort((a,b)=>b.gross-a.gross);byId('productTable').querySelector('tbody').innerHTML=perf.map(p=>`<tr><td>${p.sku}</td><td>${p.name}</td><td>${p.cat}</td><td>${USD.format(p.price)}</td><td>${fmtN(p.units30)}</td><td>${USD.format(p.gross)}</td><td>${p.returnPct}%</td><td>${p.rating}‚òÖ</td></tr>`).join('');const totalGross=perf.reduce((s,p)=>s+p.gross,0);const top=perf[0];const elecShare=Math.round(perf.filter(p=>p.cat==='Electronics').reduce((s,p)=>s+p.gross,0)/totalGross*100);byId('productKPIs').innerHTML=`<div class="card"><div class="kpi">${USD.format(totalGross)}</div><div class="kpi-sub">30-Day Product Revenue</div></div><div class="card"><div class="kpi">${top.name}</div><div class="kpi-sub">Top Grossing SKU</div></div><div class="card"><div class="kpi">${elecShare}%</div><div class="kpi-sub">Electronics Revenue Share</div></div>`}

/* -------------------------- INVENTORY -------------------------- */
function buildInventoryData(){return PRODUCTS.map(p=>{const onHand=10+Math.floor(Math.random()*400), allocated=Math.floor(onHand*Math.random()*0.25), back=Math.floor(Math.random()*10), turn=(Math.random()*4+0.6).toFixed(2), shrink=(Math.random()*1.8).toFixed(2);const valuation=onHand*p.price;const rop= 8+Math.floor(Math.random()*40);const eta=['2d','4d','7d','12d','‚Äì'][pickWeighted([30,25,20,15,10])];return {...p,onHand,allocated,back,turn,shrink,valuation,rop,eta}})}
const INV = buildInventoryData();
function renderInventory(){const totOH=INV.reduce((s,x)=>s+x.onHand,0), totVal=INV.reduce((s,x)=>s+x.valuation,0), bo=INV.reduce((s,x)=>s+x.back,0), avgTurn=(INV.reduce((s,x)=>s+Number(x.turn),0)/INV.length).toFixed(2);byId('invKPIs').innerHTML=`<div class="card"><div class="kpi">${fmtN(totOH)}</div><div class="kpi-sub">Units On Hand</div></div><div class="card"><div class="kpi">${USD.format(totVal)}</div><div class="kpi-sub">Inventory Valuation</div></div><div class="card"><div class="kpi">${fmtN(bo)}</div><div class="kpi-sub">Backorders</div></div><div class="card"><div class="kpi">${avgTurn}x</div><div class="kpi-sub">Avg Turns (30d)</div></div>`;const catAgg={Electronics:0,Home:0,Apparel:0,Sports:0,Grocery:0};INV.forEach(i=>catAgg[i.cat]+=i.onHand);invCatChart=new Chart(byId('invCatChart'),{type:'bar',data:{labels:Object.keys(catAgg),datasets:[{label:'Units',data:Object.values(catAgg),backgroundColor:'#22c55e'}]},options:{plugins:{legend:{display:false}}}});byId('invReorder').querySelector('tbody').innerHTML=INV.filter(x=>x.onHand<x.rop).sort((a,b)=>a.onHand-a.rop-(b.onHand-b.rop)).slice(0,10).map(x=>`<tr><td>${x.sku}</td><td>${x.name}</td><td>${fmtN(x.onHand)}</td><td>${fmtN(x.rop)}</td><td>${x.eta}</td></tr>`).join('');byId('invTable').querySelector('tbody').innerHTML=INV.slice(0,200).map(x=>`<tr><td>${x.sku}</td><td>${x.name}</td><td>${fmtN(x.onHand)}</td><td>${fmtN(x.allocated)}</td><td>${fmtN(x.back)}</td><td>${x.turn}x</td><td>${x.shrink}%</td><td>${USD.format(x.valuation)}</td></tr>`).join('')}

/* -------------------------- MARKETING -------------------------- */
function renderMarketing(){const spend=120000+Math.random()*40000, revenue=spend*4.8, roas=(revenue/spend).toFixed(2), cac=(12+Math.random()*10).toFixed(0), emailOpen=(28+Math.random()*8).toFixed(1), ctr=(3.2+Math.random()*1.4).toFixed(1);byId('mktKPIs').innerHTML=`<div class="card"><div class="kpi">${USD.format(spend)}</div><div class="kpi-sub">Ad Spend (30d)</div></div><div class="card"><div class="kpi">${USD.format(revenue)}</div><div class="kpi-sub">Attributed Revenue</div></div><div class="card"><div class="kpi">${roas}x</div><div class="kpi-sub">ROAS</div></div><div class="card"><div class="kpi">${cac}</div><div class="kpi-sub">CAC ($)</div></div>`;mktAttrChart=new Chart(byId('mktAttrChart'),{type:'doughnut',data:{labels:['Paid Search','Paid Social','Email','Organic','Referral'],datasets:[{data:[28,24,18,22,8],backgroundColor:['#60a5fa','#7c3aed','#22c55e','#f97316','#a78bfa']}]},options:{plugins:{legend:{position:'bottom'}}}});mktRoasChart=new Chart(byId('mktRoasChart'),{type:'bar',data:{labels:['Search','Social','Email','Affiliate','Display'],datasets:[{label:'ROAS',data:[4.2,3.6,6.1,2.8,1.9],backgroundColor:'#60a5fa'}]},options:{plugins:{legend:{display:false}}}})}

/* -------------------------- P&L -------------------------- */
function renderPnL(){const revMonth=AGG.net, cogs=Math.round(revMonth*0.58), gm=revMonth-cogs, gmPct=Math.round(gm/revMonth*1000)/10, opex=Math.round(revMonth*0.28), ebitda=gm-opex;byId('pnlKPIs').innerHTML=`<div class="card"><div class="kpi">${USD.format(revMonth)}</div><div class="kpi-sub">Revenue (Mo-to-date)</div></div><div class="card"><div class="kpi">${USD.format(cogs)}</div><div class="kpi-sub">COGS</div></div><div class="card"><div class="kpi">${USD.format(gm)} (${gmPct}%)</div><div class="kpi-sub">Gross Margin</div></div><div class="card"><div class="kpi">${USD.format(ebitda)}</div><div class="kpi-sub">EBITDA</div></div>`;const months=['Oct','Nov','Dec','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep'];const rev=months.map((_,i)=>820000+i*42000+Math.random()*90000);const cogsS=rev.map(v=>Math.round(v*0.59));const gmS=rev.map((v,i)=>v-cogsS[i]);pnlChart=new Chart(byId('pnlChart'),{type:'line',data:{labels:months,datasets:[{label:'Revenue',data:rev,borderColor:'#60a5fa',tension:.35},{label:'COGS',data:cogsS,borderColor:'#ef4444',tension:.35},{label:'Gross Margin',data:gmS,borderColor:'#22c55e',tension:.35}]},options:{responsive:true}})}

/* -------------------------- LOGISTICS -------------------------- */
function renderLogistics(){const orders=AGG.orders, onTime=(94+Math.random()*4).toFixed(1), avgSla=(18+Math.random()*6).toFixed(1), whThroughput= (1200+Math.random()*600).toFixed(0);byId('logKPIs').innerHTML=`<div class="card"><div class="kpi">${fmtN(orders)}</div><div class="kpi-sub">Parcels (today)</div></div><div class="card"><div class="kpi">${onTime}%</div><div class="kpi-sub">On-time Delivery</div></div><div class="card"><div class="kpi">${avgSla}h</div><div class="kpi-sub">Avg Fulfillment SLA</div></div><div class="card"><div class="kpi">${fmtN(whThroughput)}/d</div><div class="kpi-sub">Warehouse Throughput</div></div>`;logCarrierChart=new Chart(byId('logCarrierChart'),{type:'doughnut',data:{labels:['UPS','FedEx','USPS','Other'],datasets:[{data:[38,34,24,4],backgroundColor:['#60a5fa','#22c55e','#f59e0b','#a78bfa']}]},options:{plugins:{legend:{position:'bottom'}}}});logSlaChart=new Chart(byId('logSlaChart'),{type:'bar',data:{labels:['Pick','Pack','Label','Dispatch','Transit'],datasets:[{label:'Avg Hours',data:[2.4,3.1,0.6,1.2,14.3],backgroundColor:'#7c3aed'}]},options:{plugins:{legend:{display:false}}}})}

/* -------------------------- ACCOUNTS -------------------------- */
function renderAccounts(){const body=byId('accTable').querySelector('tbody');body.innerHTML=ACCOUNTS.slice(0,200).map(a=>`<tr><td>${a.acc}</td><td>${a.city}</td><td>${a.contact}</td><td>${USD.format(a.bal)}</td><td><span class="badge">${a.st}</span></td></tr>`).join('');const k=[{h:'Accounts',v:ACCOUNTS.length},{h:'Open Balance',v:USD.format(ACCOUNTS.reduce((s,a)=>s+a.bal,0))},{h:'Overdue',v:USD.format(ACCOUNTS.filter(a=>a.st==='Overdue').reduce((s,a)=>s+a.bal,0))}];byId('accKPIs').innerHTML=k.map(x=>`<div class="card"><div class="kpi">${x.v}</div><div class="kpi-sub">${x.h}</div></div>`).join('')}

/* -------------------------- SUPPORT -------------------------- */
function renderSupport(){const backlog=120+Math.floor(Math.random()*80), frt=(18+Math.random()*10).toFixed(1), ttr=(36+Math.random()*20).toFixed(1), nps=(45+Math.random()*15).toFixed(0);byId('supKPIs').innerHTML=`<div class="card"><div class="kpi">${fmtN(backlog)}</div><div class="kpi-sub">Ticket Backlog</div></div><div class="card"><div class="kpi">${frt}m</div><div class="kpi-sub">First Response</div></div><div class="card"><div class="kpi">${ttr}h</div><div class="kpi-sub">Avg Resolution</div></div><div class="card"><div class="kpi">${nps}</div><div class="kpi-sub">NPS</div></div>`;supTypeChart=new Chart(byId('supTypeChart'),{type:'doughnut',data:{labels:['Order','Payment','Returns','Tech','Other'],datasets:[{data:[38,18,22,12,10],backgroundColor:['#60a5fa','#22c55e','#f97316','#a78bfa','#f59e0b']}]},options:{plugins:{legend:{position:'bottom'}}}});supCsatChart=new Chart(byId('supCsatChart'),{type:'line',data:{labels:['W1','W2','W3','W4'],datasets:[{label:'CSAT %',data:[86,88,84,89],borderColor:'#22c55e',tension:.3}]},options:{responsive:true}});const body=byId('supTable').querySelector('tbody');const rows=Array.from({length:40},(_,i)=>({id:'TKT'+(8000+i), ch:['Email','Chat','Phone'][i%3], type:['Order','Payment','Returns','Tech'][i%4], pri:['Low','Med','High'][pickWeighted([50,35,15])], frt:(10+Math.random()*20).toFixed(1)+'m', res:(12+Math.random()*36).toFixed(1)+'h', csat:(80+Math.random()*15).toFixed(0)+'%'}));body.innerHTML=rows.map(r=>`<tr><td>${r.id}</td><td>${r.ch}</td><td>${r.type}</td><td>${r.pri}</td><td>${r.frt}</td><td>${r.res}</td><td>${r.csat}</td></tr>`).join('')}

/* -------------------------- AI SEARCH MODELS -------------------------- */
function renderAI(){const idxQps=(1200+Math.random()*400).toFixed(0), hit=(72+Math.random()*8).toFixed(1), latency=(110+Math.random()*40).toFixed(0), cost='$'+(420+Math.random()*160).toFixed(0)+'/d';byId('aiKPIs').innerHTML=`<div class="card"><div class="kpi">${fmtN(idxQps)}/m</div><div class="kpi-sub">Queries Indexed</div></div><div class="card"><div class="kpi">${hit}%</div><div class="kpi-sub">Hit Rate (top-10)</div></div><div class="card"><div class="kpi">${latency}ms</div><div class="kpi-sub">Median Latency</div></div><div class="card"><div class="kpi">${cost}</div><div class="kpi-sub">Inferred Cost</div></div>`;aiRecallChart=new Chart(byId('aiRecallChart'),{type:'bar',data:{labels:['v1.1','v1.2','v2.0','v2.1'],datasets:[{label:'Recall@10 %',data:[76.2,78.9,82.5,84.1],backgroundColor:'#60a5fa'}]},options:{plugins:{legend:{display:false}}}});aiLatencyChart=new Chart(byId('aiLatencyChart'),{type:'line',data:{labels:['v1.1','v1.2','v2.0','v2.1'],datasets:[{label:'p50',data:[95,92,88,85],borderColor:'#22c55e',tension:.3},{label:'p95',data:[220,205,180,170],borderColor:'#f97316',tension:.3}]},options:{responsive:true}});const body=byId('aiTable').querySelector('tbody');const rows=[['DualEnc','v2.1',84.1,0.52,'170ms','Best overall'],['DualEnc','v2.0',82.5,0.50,'180ms','Stable'],['BiEnc','v1.2',78.9,0.46,'205ms','Legacy'],['BiEnc','v1.1',76.2,0.44,'220ms','Legacy']];body.innerHTML=rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}%</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`).join('')}

/* -------------------------- CHATBOTS -------------------------- */
function renderBots(){const containment=(62+Math.random()*12).toFixed(1), aht=(210+Math.random()*60).toFixed(0), csat=(86+Math.random()*6).toFixed(0), intents=(18+Math.random()*7).toFixed(0);byId('botKPIs').innerHTML=`<div class="card"><div class="kpi">${containment}%</div><div class="kpi-sub">Containment</div></div><div class="card"><div class="kpi">${aht}s</div><div class="kpi-sub">Avg Handle Time</div></div><div class="card"><div class="kpi">${csat}%</div><div class="kpi-sub">CSAT</div></div><div class="card"><div class="kpi">${intents}</div><div class="kpi-sub">Intent Coverage</div></div>`;botContainChart=new Chart(byId('botContainChart'),{type:'line',data:{labels:['W1','W2','W3','W4'],datasets:[{label:'Containment %',data:[58,60,63,Number(containment)],borderColor:'#60a5fa',tension:.35}]},options:{responsive:true}});botAhtChart=new Chart(byId('botAhtChart'),{type:'bar',data:{labels:['W1','W2','W3','W4'],datasets:[{label:'AHT (s)',data:[240,230,218,Number(aht)],backgroundColor:'#7c3aed'}]},options:{plugins:{legend:{display:false}}}});const body=byId('botTable').querySelector('tbody');const rows=Array.from({length:30},(_,i)=>({id:'C'+(10000+i), ch:['Web','iOS','Android'][i%3], intent:['Order Status','Return','Refund','Product Info','Store Hours'][i%5], res:['Yes','No'][pickWeighted([72,28])], hand:['No','Yes'][pickWeighted([78,22])], csat:(80+Math.random()*18).toFixed(0)+'%'}));body.innerHTML=rows.map(r=>`<tr><td>${r.id}</td><td>${r.ch}</td><td>${r.intent}</td><td>${r.res}</td><td>${r.hand}</td><td>${r.csat}</td></tr>`).join('')}

/* -------------------------- DATA PIPELINES -------------------------- */
function renderPipes(){const freshness=(92+Math.random()*6).toFixed(1), dq=(97+Math.random()*2).toFixed(1), late=(2+Math.random()*3).toFixed(0), streams=(280+Math.random()*120).toFixed(0);byId('pipeKPIs').innerHTML=`<div class="card"><div class="kpi">${freshness}%</div><div class="kpi-sub">Data Freshness</div></div><div class="card"><div class="kpi">${dq}%</div><div class="kpi-sub">DQ Pass Rate</div></div><div class="card"><div class="kpi">${late}</div><div class="kpi-sub">Late Jobs (24h)</div></div><div class="card"><div class="kpi">${streams}/s</div><div class="kpi-sub">Stream Events</div></div>`;const batch=[['orders_daily','0 2 * * *','02:03','OK','10m'],['inventory_hourly','0 * * * *','12:00','OK','5m'],['accounts_daily','0 3 * * *','03:05','OK','12m'],['marketing_daily','0 1 * * *','01:02','Late','-']], body=byId('pipeBatch').querySelector('tbody');body.innerHTML=batch.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td><span class="badge">${r[3]}</span></td><td>${r[4]}</td></tr>`).join('');pipeStreamChart=new Chart(byId('pipeStreamChart'),{type:'line',data:{labels:['t-60','t-45','t-30','t-15','now'],datasets:[{label:'Events/sec',data:[240,260,300,320,Number(streams)],borderColor:'#60a5fa',tension:.3}]},options:{responsive:true}});const dqRules=[['orders','no null order_id',99.8,'5m ago'],['products','price > 0',99.2,'15m ago'],['inventory','on_hand >= 0',98.9,'1m ago'],['accounts','email format',99.6,'30m ago']];byId('pipeDQ').querySelector('tbody').innerHTML=dqRules.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}%</td><td>${r[3]}</td></tr>`).join('')}

/* -------------------------- USERS -------------------------- */
function renderUsers(){byId('usersTable').querySelector('tbody').innerHTML=USERS.map(u=>`<tr><td>${u.n}</td><td>${u.role}</td><td>${u.loc}</td><td>${u.active?'Yes':'No'}</td></tr>`).join('')}

/* -------------------------- INSIGHTS & SIM -------------------------- */
byId('simPromo').addEventListener('input', e=> byId('simPromoVal').textContent = e.target.value+'%');
byId('simChurn').addEventListener('input', e=> byId('simChurnVal').textContent = e.target.value+'%');
byId('runSim').addEventListener('click', ()=>{const base=AGG.mrr;const promo=Number(byId('simPromo').value)/100;const churn=Number(byId('simChurn').value)/100;const cac=Number(byId('simCAC').value);const proj=Math.round(base*(1+promo)*(1-churn));const payback=(AGG.ltv&&cac)?Math.max(1,Math.round(AGG.ltv/cac)):'‚Äì';byId('simResult').textContent=`Projected MRR: ${USD.format(proj)} (Promo +${promo*100}%, Churn ‚àí${churn*100}%) ¬∑ Est. LTV: ${USD.format(AGG.ltv)} ¬∑ CAC: ${USD.format(cac)} ¬∑ Payback (orders): ${payback}`});
function renderInsights(){const list=byId('insightsList');const card=AGG.cardShare,apple=AGG.appleShare,conv=AGG.conversion,aov=AGG.aov;list.innerHTML=`<li>Card share <strong>${card}%</strong>, Apple Pay <strong>${apple}%</strong> ‚Äî optimize tap-to-pay lanes.</li><li>Conversion <strong>${conv}%</strong> with AOV <strong>${USD.format(aov)}</strong> ‚Äî bundle pricing could lift 5‚Äì10%.</li><li>Online ~<strong>${Math.round(AGG.online/AGG.orders*100)}%</strong> of orders ‚Äî prioritize mobile PDP speed.</li><li>Returns <strong>${AGG.refundRate}%</strong> ‚Äî audit Apparel sizing and fragile packaging.</li>`}

/* -------------------------- ALERTS & SETTINGS -------------------------- */
byId('saveAlerts').addEventListener('click', ()=>{const msg=`Saved thresholds: returns>${byId('thReturn').value}%, card>${byId('thCard').value}%, AOV>${byId('thAOV').value}`;const el=document.createElement('div');el.textContent=new Date().toLocaleTimeString()+' ‚Ä¢ '+msg;byId('alertLog').prepend(el)});
byId('saveSettings').addEventListener('click', ()=>{localStorage.setItem('ab_pref_email', byId('prefEmail').checked?'1':'0');localStorage.setItem('ab_pref_light', byId('prefTheme').checked?'1':'0');if(byId('prefTheme').checked) document.body.classList.add('light'); else document.body.classList.remove('light');alert('Preferences saved')});
byId('exportSnapshot').addEventListener('click', ()=>{const snap={ts:new Date().toISOString(),agg:AGG,stores:STORES};const blob=new Blob([JSON.stringify(snap,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='ab_snapshot.json';a.click();URL.revokeObjectURL(url)});

/* -------------------------- Live tick -------------------------- */
setInterval(()=>{const nb=makeOrder(100000+Math.floor(Math.random()*900000));ORDERS.unshift(nb);if(ORDERS.length>1200) ORDERS.pop();Object.assign(AGG,aggregate());renderKPIs();if(hourlyChart){const nowH=new Date().getHours();const label=`${String(nowH).padStart(2,'0')}:00`;const idx=hourlyChart.data.labels.indexOf(label);if(idx>=0){hourlyChart.data.datasets[0].data[idx]+=nb.total;hourlyChart.update('none')}}},20000);

/* -------------------------- Boot -------------------------- */
function boot(){
  renderKPIs(); renderOrders(); renderProducts(); renderInventory(); renderMarketing(); renderPnL(); renderLogistics(); renderAccounts(); renderSupport(); renderAI(); renderBots(); renderPipes();
  buildHourly(); buildWeekly(); buildCategory(); buildPayment(); buildTopItems(); buildRegionStacked(); buildMonthly();
  renderInsights(); byId('yr').textContent=new Date().getFullYear();
}
boot();
</script>
</body>
</html>
