<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aurelo Bay ‚Äî Retail Analytics (USD)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#071027; --panel:#0f1724; --muted:#93a8bf; --accent:#60a5fa; --glass:rgba(255,255,255,0.04);
  --card:#0b1220; --text:#e6eef8; --text-muted:#93a8bf;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),#05111b);color:var(--text);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
.container{max-width:1480px;margin:18px auto;display:grid;grid-template-columns:260px 1fr;gap:18px;padding:12px}
aside.sidebar{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:16px;height:calc(100vh - 36px);position:sticky;top:18px}
.logo{display:flex;align-items:center;gap:12px;margin-bottom:8px}
.brand-circle{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(90deg,#7c3aed,#06b6d4);font-weight:800}
.brand-title{font-weight:700;font-size:16px}
nav#mainNav{display:flex;flex-direction:column;gap:6px;margin-top:12px}
button.nav-btn{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:0;background:transparent;color:var(--text-muted);cursor:pointer;text-align:left;font-size:14px}
button.nav-btn:hover{background:var(--glass);color:#fff}
button.nav-btn.active{background:linear-gradient(90deg,rgba(99,102,241,0.12),rgba(6,182,212,0.06));color:#fff}
.sidebar .section-title{font-size:12px;color:var(--text-muted);margin-top:12px}
.pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--text-muted);font-weight:600}
.sidebar .actions{display:flex;flex-direction:column;gap:8px;margin-top:12px}
main{padding:6px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.search-box{display:flex;gap:8px;align-items:center}
input.search{padding:9px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:inherit;min-width:260px}
.btn{padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:#05203b;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.12);color:var(--text-muted)}
.grid{display:grid;gap:12px}
.cols-2{grid-template-columns:repeat(2,1fr)}
.cols-3{grid-template-columns:repeat(3,1fr)}
.cols-4{grid-template-columns:repeat(4,1fr)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.08)}
.kpi{font-size:20px;font-weight:800}
.kpi-sub{color:var(--text-muted);font-size:12px}
.muted{color:var(--text-muted);font-size:13px}
.badge{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.08);font-weight:700}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{color:var(--text-muted);text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,0.12)}
tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.06)}
.page{display:none}
.page.active{display:block}
footer{margin-top:18px;color:var(--text-muted);font-size:12px;text-align:center}
/* Light theme */
body.light{--bg:#fff; --panel:#f2f4f8; --text:#000; --text-muted:#444; --card:#fefefe; --glass:rgba(0,0,0,0.06)}
@media (max-width: 980px){.container{grid-template-columns:1fr} aside.sidebar{height:auto;position:relative}}
</style>
</head>
<body>
<div class="container">
  <!-- SIDEBAR -->
  <aside class="sidebar" aria-label="Sidebar">
    <div class="logo">
      <div class="brand-circle">AB</div>
      <div>
        <div class="brand-title">Aurelo Bay</div>
        <div class="muted" style="font-size:12px">Retail & e-Com Analytics</div>
      </div>
    </div>
    <nav id="mainNav" aria-label="Primary">
      <button class="nav-btn active" data-page="overview">üè† Overview</button>
      <button class="nav-btn" data-page="sales">üßæ Sales (Orders)</button>
      <button class="nav-btn" data-page="products">üõí Products</button>
      <button class="nav-btn" data-page="analytics">üìà Analytics</button>
      <button class="nav-btn" data-page="accounts">üè¶ Accounts</button>
      <button class="nav-btn" data-page="users">üë• Users</button>
      <button class="nav-btn" data-page="alerts">üö® Alerts</button>
      <button class="nav-btn" data-page="settings">‚öôÔ∏è Settings</button>
    </nav>

    <div class="section-title">Bay Area Stores</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <div class="pill">San Francisco</div>
      <div class="pill">San Jose</div>
      <div class="pill">Oakland</div>
      <div class="pill">Palo Alto</div>
      <div class="pill">Berkeley</div>
      <div class="pill">Online</div>
    </div>

    <div class="section-title">Data Ops</div>
    <nav aria-label="Data Operations" style="display:flex;flex-direction:column;gap:6px;margin-top:8px">
      <button class="nav-btn" data-page="dataPackets">üß© Data Packets</button>
      <button class="nav-btn" data-page="inventory">üì¶ Inventory Mgmt</button>
      <button class="nav-btn" data-page="suppliers">ü§ù Suppliers</button>
    </nav>

    <div class="section-title">Quick actions</div>
    <div class="actions">
      <button id="exportSnapshot" class="btn">Export snapshot</button>
      <button id="toggleTheme" class="btn ghost">Toggle theme</button>
    </div>
  </aside>

  <!-- MAIN -->
  <main>
    <div class="header">
      <div class="search-box">
        <input id="globalSearch" class="search" placeholder="Search orders, items, customers, accounts..." />
      </div>
      <div class="muted">Manager: Monish ‚Ä¢ Admin</div>
    </div>

    <!-- OVERVIEW -->
    <section id="overview" class="page active">
      <h2>Overview</h2>
      <div class="grid cols-4" id="kpiGrid"></div>

      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Today ‚Äî Hourly Sales</strong>
            <span class="muted" id="todayRange"></span>
          </div>
          <canvas id="hourlyChart" height="140"></canvas>
        </div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>This Week ‚Äî Daily Revenue</strong>
            <span class="muted" id="weekTotal"></span>
          </div>
          <canvas id="weeklyChart" height="140"></canvas>
        </div>
      </div>

      <div class="grid cols-3" style="margin-top:12px">
        <div class="card">
          <strong>Category Mix</strong>
          <div class="muted" style="margin:6px 0">Electronics, Home, Apparel, Sports, Grocery</div>
          <canvas id="categoryChart" height="160"></canvas>
        </div>
        <div class="card">
          <strong>Payment Mix</strong>
          <div class="muted" style="margin:6px 0">Card, Apple Pay, Google Pay, Cash</div>
          <canvas id="paymentChart" height="160"></canvas>
        </div>
        <div class="card">
          <strong>Top Products (Today)</strong>
          <div class="muted" style="margin:6px 0">Qty sold by SKU</div>
          <canvas id="topItemsChart" height="160"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Sales by City (This Month)</strong>
        <canvas id="regionStackedChart" height="140"></canvas>
      </div>
    </section>

    <!-- SALES / ORDERS -->
    <section id="sales" class="page">
      <h2>Orders</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
        <input id="orderSearch" class="search" style="min-width:240px" placeholder="Search order ID / email / item / city" />
        <select id="orderStore" class="btn ghost" style="padding:8px;border-radius:8px">
          <option value="">All stores</option><option>San Francisco</option><option>San Jose</option>
          <option>Oakland</option><option>Palo Alto</option><option>Berkeley</option><option>Online</option>
        </select>
        <select id="orderPay" class="btn ghost" style="padding:8px;border-radius:8px">
          <option value="">All payment</option><option>Card</option><option>Apple Pay</option><option>Google Pay</option><option>Cash</option>
        </select>
        <button id="exportOrders" class="btn">Export CSV</button>
      </div>
      <div class="card table-wrap">
        <table id="orderTable">
          <thead>
            <tr>
              <th>Order</th><th>Time</th><th>Store</th><th>Channel</th><th>Items</th>
              <th>Sub-total</th><th>Tax (8.75%)</th><th>Total</th><th>Payment</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" id="orderCount" style="margin-top:8px">0 orders</div>
    </section>

    <!-- PRODUCTS -->
    <section id="products" class="page">
      <h2>Products</h2>
      <div class="grid cols-3" id="productKPIs"></div>
      <div class="card table-wrap" style="margin-top:12px">
        <table id="productTable">
          <thead>
            <tr><th>SKU</th><th>Name</th><th>Category</th><th>Price</th><th>Units (30d)</th><th>Gross Sales</th><th>Return %</th><th>Rating</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="analytics" class="page">
      <h2>Analytics & Simulator</h2>
      <div class="grid cols-2">
        <div class="card">
          <strong>Scenario: Promo vs Churn (Subscriptions)</strong>
          <div style="display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap">
            <label class="muted">Promo% <input id="simPromo" type="range" min="0" max="40" value="12" /></label>
            <span id="simPromoVal" class="badge">12%</span>
            <label class="muted" style="margin-left:10px">Churn% <input id="simChurn" type="range" min="0" max="15" value="3" /></label>
            <span id="simChurnVal" class="badge">3%</span>
            <label class="muted" style="margin-left:10px">New CAC ($) <input id="simCAC" type="number" value="14" style="width:70px" /></label>
            <button id="runSim" class="btn">Run</button>
          </div>
          <div class="muted" id="simResult" style="margin-top:8px">Adjust sliders and run.</div>
        </div>
        <div class="card">
          <strong>Insights</strong>
          <ul id="insightsList" class="muted" style="margin-top:6px"></ul>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Monthly Revenue (Last 12m vs Prev 12m)</strong>
        <canvas id="monthlyChart" height="160"></canvas>
      </div>
    </section>

    <!-- ACCOUNTS -->
    <section id="accounts" class="page">
      <h2>B2B / Wholesale Accounts</h2>
      <div class="grid cols-3" id="accKPIs"></div>
      <div class="card table-wrap" style="margin-top:12px">
        <table id="accTable">
          <thead><tr><th>Account</th><th>City</th><th>Contact</th><th>Open Balance</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- USERS -->
    <section id="users" class="page">
      <h2>Users</h2>
      <div class="card table-wrap">
        <table id="usersTable">
          <thead><tr><th>Name</th><th>Role</th><th>Location</th><th>Active</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ALERTS -->
    <section id="alerts" class="page">
      <h2>Alerts</h2>
      <div class="card">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label class="muted">High returns > <input id="thReturn" type="number" value="6" style="width:64px"> %</label>
          <label class="muted">Card share < input id="thCard" type="number" value="50" style="width:64px"> %</label>
          <label class="muted">AOV > < input id="thAOV" type="number" value="85" style="width:64px"> $</label>
          <button id="saveAlerts" class="btn">Save</button>
        </div>
      </div>
      <div id="alertLog" class="muted" style="margin-top:8px"></div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="page">
      <h2>Settings</h2>
      <div class="card">
        <label class="muted"><input id="prefEmail" type="checkbox" checked> Email daily summary</label>
        <div style="height:8px"></div>
        <label class="muted"><input id="prefTheme" type="checkbox"> Start in Light theme</label>
        <div style="margin-top:10px"><button id="saveSettings" class="btn">Save preferences</button></div>
      </div>
      <footer>¬© <span id="yr"></span> Aurelo Bay</footer>
    </section>

    <!-- DATA PACKETS -->
    <section id="dataPackets" class="page">
      <h2>Data Packets Marketplace</h2>
      <div class="grid cols-4" id="dpKPIs"></div>
      <div class="card" style="margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="dpSearch" class="search" placeholder="Search packets, schemas, tags..."/>
          <select id="dpCategory" class="btn ghost" style="padding:8px;border-radius:8px">
            <option value="">All categories</option>
            <option value="POS">POS</option>
            <option value="E‚Äëcom">E‚Äëcom</option>
            <option value="Footfall">Footfall</option>
            <option value="Pricing">Pricing</option>
            <option value="Supply">Supply</option>
          </select>
          <label class="muted">Min quality <input id="dpQmin" type="range" min="60" max="99" value="80"/></label>
          <span id="dpQval" class="badge">80</span>
          <button id="exportPackets" class="btn">Export catalog CSV</button>
        </div>
      </div>
      <div class="card table-wrap" style="margin-top:12px">
        <table id="dpTable">
          <thead>
            <tr>
              <th>Packet</th><th>Category</th><th>Schema Fields</th><th>Rows</th><th>Size</th>
              <th>Refresh</th><th>Quality</th><th>Price/mo</th><th>License</th><th>Downloads</th><th>Updated</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card" style="margin-top:12px">
        <strong>Revenue by Category (Last 30d)</strong>
        <canvas id="dpRevenueChart" height="160"></canvas>
      </div>
    </section>

    <!-- INVENTORY MGMT -->
    <section id="inventory" class="page">
      <h2>Inventory Management</h2>
      <div class="grid cols-4" id="invKPIs"></div>
      <div style="display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap">
        <select id="invStore" class="btn ghost" style="padding:8px;border-radius:8px">
          <option value="">All stores</option><option>San Francisco</option><option>San Jose</option>
          <option>Oakland</option><option>Palo Alto</option><option>Berkeley</option><option>Online</option>
        </select>
        <button id="recalcEOQ" class="btn">Recalculate EOQ</button>
        <button id="exportInventory" class="btn">Export Inventory CSV</button>
      </div>
      <div class="card table-wrap">
        <table id="invTable">
          <thead>
            <tr>
              <th>SKU</th><th>Name</th><th>Category</th><th>In Stock</th><th>On Order</th><th>Backorder</th>
              <th>Unit Cost</th><th>Price</th><th>Margin%</th><th>Demand (30d)</th><th>Forecast (30d)</th>
              <th>ROP</th><th>Safety</th><th>EOQ</th><th>Lead (d)</th><th>Supplier</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card"><strong>Low-Stock Count by Category</strong><canvas id="invLowChart" height="160"></canvas></div>
        <div class="card"><strong>Days of Supply Distribution</strong><canvas id="invDOSChart" height="160"></canvas></div>
      </div>
    </section>

    <!-- SUPPLIERS -->
    <section id="suppliers" class="page">
      <h2>Suppliers</h2>
      <div class="grid cols-4" id="supKPIs"></div>
      <div class="card table-wrap" style="margin-top:12px">
        <table id="supTable">
          <thead>
            <tr>
              <th>Supplier</th><th>Category</th><th>Lead (d)</th><th>On-time%</th><th>Defect%</th>
              <th>MOQ</th><th>Payment</th><th>Price Index</th><th>Spend YTD</th><th>Risk</th><th>Contact</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card" style="margin-top:12px">
        <strong>On-time vs Defect Rate</strong>
        <canvas id="supScatter" height="180"></canvas>
      </div>
    </section>
  </main>
</div>

<script>
/* -------------------------- Utilities -------------------------- */
const USD = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', maximumFractionDigits:0 });
const fmtN = n => new Intl.NumberFormat('en-US').format(n);
const byId = id => document.getElementById(id);
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const todayStr = () => new Date().toLocaleDateString('en-US',{weekday:'short', month:'short', day:'2-digit'});

/* -------------------------- Navigation + Theme -------------------------- */
$('#mainNav').addEventListener('click', e=>{
  const btn = e.target.closest('.nav-btn'); if(!btn) return;
  $$('.nav-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
  const id = btn.dataset.page; $$('.page').forEach(p=>p.classList.toggle('active', p.id===id));
  history.pushState({page:id}, '', '#'+id);
});
window.addEventListener('popstate', (e)=>{ const id = (e.state&&e.state.page)||location.hash.replace('#','')||'overview';
  $$('.nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.page===id));
  $$('.page').forEach(p=>p.classList.toggle('active', p.id===id));
});
byId('toggleTheme').addEventListener('click', ()=>{ document.body.classList.toggle('light'); localStorage.setItem('ab_theme', document.body.classList.contains('light')?'light':'dark'); });
(function(){ if(localStorage.getItem('ab_theme')==='light') document.body.classList.add('light'); })();

/* -------------------------- Simulated Retail Data (Bay Area, USD) -------------------------- */
const STORES = ['San Francisco','San Jose','Oakland','Palo Alto','Berkeley','Online'];
const PAY = ['Card','Apple Pay','Google Pay','Cash'];      // weights ~ [55,20,10,15]
const CHANNEL = ['In-store','Online'];
const CATEGORY = ['Electronics','Home','Apparel','Sports','Grocery'];
const TAX_RATE = 0.0875; // blended CA rate 8.75%

/* Product catalog (40 SKUs across categories) */
const PRODUCTS = [
  ['ELEC-001','Aurelo Smart Speaker','Electronics',129],
  ['ELEC-002','Noise-Cancel Headphones','Electronics',199],
  ['ELEC-003','4K Streaming Stick','Electronics',59],
  ['ELEC-004','Wireless Charger','Electronics',39],
  ['ELEC-005','USB-C Hub 8-in-1','Electronics',79],
  ['HOME-101','LED Floor Lamp','Home',89],
  ['HOME-102','Ergo Office Chair','Home',179],
  ['HOME-103','Bamboo Cutting Board','Home',24],
  ['HOME-104','Aromatherapy Diffuser','Home',49],
  ['HOME-105','Espresso Machine','Home',349],
  ['APRL-201','Hoodie ‚Äî Unisex','Apparel',65],
  ['APRL-202','Performance Tee','Apparel',35],
  ['APRL-203','Running Shorts','Apparel',45],
  ['APRL-204','Windbreaker','Apparel',98],
  ['APRL-205','Everyday Jeans','Apparel',79],
  ['SPRT-301','Yoga Mat Pro','Sports',59],
  ['SPRT-302','Adjustable Dumbbells','Sports',229],
  ['SPRT-303','Foam Roller','Sports',29],
  ['SPRT-304','Cycling Helmet','Sports',85],
  ['SPRT-305','Tennis Racket','Sports',119],
  ['GROC-401','Organic Coffee Beans (1lb)','Grocery',16],
  ['GROC-402','Almond Butter (16oz)','Grocery',12],
  ['GROC-403','Protein Bars (12pk)','Grocery',18],
  ['GROC-404','Sparkling Water (12pk)','Grocery',11],
  ['GROC-405','Olive Oil (1L)','Grocery',19],
  ['ELEC-006','Bluetooth Tracker (4-pk)','Electronics',69],
  ['ELEC-007','Smart Bulb (2-pk)','Electronics',29],
  ['HOME-106','Air Purifier','Home',199],
  ['HOME-107','Cast Iron Skillet','Home',44],
  ['APRL-206','Baseball Cap','Apparel',28],
  ['APRL-207','Sneakers','Apparel',120],
  ['SPRT-306','Fitness Band','Sports',99],
  ['SPRT-307','Jump Rope','Sports',18],
  ['GROC-406','Trail Mix (2lb)','Grocery',14],
  ['GROC-407','Kombucha (6pk)','Grocery',16],
  ['ELEC-008','Portable SSD 1TB','Electronics',119],
  ['HOME-108','Smart Thermostat','Home',229],
  ['APRL-208','Socks (6-pk)','Apparel',22],
  ['SPRT-308','Pickleball Set','Sports',89],
  ['GROC-408','Oat Milk (64oz)','Grocery',6]
].map(([sku,name,cat,price])=>({sku,name,cat,price}));

/* Data Packet categories */
const DP_CATS = ['POS','E‚Äëcom','Footfall','Pricing','Supply'];

/* Weighted pick helper */
function pickWeighted(weights){
  const total = weights.reduce((a,b)=>a+b,0); let r = Math.random()*total;
  for(let i=0;i<weights.length;i++){ if(r<weights[i]) return i; r-=weights[i]; }
  return weights.length-1;
}

/* Build a random order */
function makeOrder(idx){
  const store = STORES[pickWeighted([22,22,16,14,12,14])];
  const channel = CHANNEL[pickWeighted([70,30])];
  const pm = PAY[pickWeighted([55,20,10,15])];
  const itemCount = 1 + Math.floor(Math.random()*4);
  const items = []; let subtotal = 0; let qtyTotal = 0;
  for(let i=0;i<itemCount;i++){
    const p = PRODUCTS[pickWeighted([
      8,8,7,7,7, 7,6,5,5,6, 7,7,6,6,6, 6,5,5,5,5, 5,5,5,5,5, 6,6,5,5,4, 5,5,4,4,4, 6,5,4,4
    ])];
    const qty = 1 + Math.floor(Math.random()*3);
    items.push({sku:p.sku, name:p.name, cat:p.cat, price:p.price, qty});
    subtotal += p.price * qty; qtyTotal += qty;
  }
  const tax = Math.round(subtotal * TAX_RATE);
  const total = subtotal + tax;
  const now = new Date(); const hour = Math.floor(Math.random()*(now.getHours()||10));
  const time = new Date(); time.setHours(hour, Math.floor(Math.random()*60), 0, 0);
  return {
    order: 'AB'+String(100000+idx),
    time: time.toTimeString().slice(0,5),
    store, channel, items, qty:qtyTotal,
    subtotal, tax, total, pay: pm
  };
}

/* Generate a large set of orders (today) + buffer */
const ORDERS = Array.from({length: 720}, (_,i)=> makeOrder(i));

/* B2B accounts */
const ACCOUNTS = Array.from({length: 220}, (_,i)=>({
  acc: `Account ${i+1}`,
  city: ['San Francisco','San Jose','Oakland','Palo Alto','Berkeley'][i%5],
  contact: `+1 (415) ${200+Math.floor(Math.random()*700)}-${String(1000+Math.floor(Math.random()*9000)).slice(-4)}`,
  bal: Math.round(2000 + Math.random()*120000),
  st: ['Active','Overdue','Settled'][pickWeighted([70,12,18])]
}));

/* Users */
const USERS = [
  {n:'Riley Chen', role:'Store Manager', loc:'San Francisco', active:true},
  {n:'Jordan Patel', role:'Ops Analyst', loc:'San Jose', active:true},
  {n:'Avery Kim', role:'Cashier', loc:'Oakland', active:true},
  {n:'Sam Rivera', role:'E-Com Lead', loc:'Online', active:true},
  {n:'Taylor Brooks', role:'Sales Associate', loc:'Palo Alto', active:false},
];

/* -------------------------- KPI Aggregation -------------------------- */
function aggregate(){
  const gross = ORDERS.reduce((s,b)=>s+b.total,0);
  const net = ORDERS.reduce((s,b)=>s+b.subtotal,0);
  const tax = ORDERS.reduce((s,b)=>s+b.tax,0);
  const orders = ORDERS.length;
  const itemsSold = ORDERS.reduce((s,b)=>s+b.qty,0);
  const aov = Math.round(net / orders);
  const cardShare = Math.round(ORDERS.filter(b=>b.pay==='Card').length / orders * 100);
  const appleShare = Math.round(ORDERS.filter(b=>b.pay==='Apple Pay').length / orders * 100);
  const online = ORDERS.filter(b=>b.channel==='Online').length;
  const instore = orders - online;
  const returns = Math.round(orders * 0.035);
  const refundRate = Math.round(returns / orders * 1000)/10;
  const repeatCust = Math.round(orders * 0.22);
  const newCust = orders - repeatCust;
  const visitors = 18000 + Math.floor(Math.random()*6000);
  const conversion = Math.round((orders/visitors)*1000)/10;
  const rpv = Math.round((net/visitors)*100)/100;
  const mrr = Math.round((net*0.12)/12);
  const cac = 14 + Math.round(Math.random()*8);
  const ltv = Math.round(aov * (3 + Math.random()*6));
  return {gross, net, tax, orders, aov, itemsSold, cardShare, appleShare, online, instore, returns, refundRate, repeatCust, newCust, visitors, conversion, rpv, mrr, cac, ltv};
}
const AGG = aggregate();

/* -------------------------- Overview KPIs -------------------------- */
function renderKPIs(){
  const grid = byId('kpiGrid');
  const rows = [
    {label:'Gross Sales (Today)', val: USD.format(AGG.gross), sub:'+9.8% vs yesterday'},
    {label:'Net Sales (ex-tax)', val: USD.format(AGG.net), sub:'Sales tax 8.75%'},
    {label:'Orders', val: fmtN(AGG.orders), sub:`In-store ${fmtN(AGG.instore)} ¬∑ Online ${fmtN(AGG.online)}`},
    {label:'Avg Order Value', val: USD.format(AGG.aov), sub:'AOV'},
    {label:'Items Sold', val: fmtN(AGG.itemsSold), sub:'Units'},
    {label:'Sales Tax Collected', val: USD.format(AGG.tax), sub:'To remit'},
    {label:'Card Share', val: AGG.cardShare+'%', sub:'Card MDR optimization'},
    {label:'Apple Pay Share', val: AGG.appleShare+'%', sub:'Express checkout'},
    {label:'Returns', val: fmtN(AGG.returns), sub:`Refund rate ${AGG.refundRate}%`},
    {label:'Customers', val: `${fmtN(AGG.newCust)} new / ${fmtN(AGG.repeatCust)} repeat`, sub:'Repeat ‚âà22%'},
    {label:'Conversion', val: AGG.conversion+'%', sub:`Visitors ${fmtN(AGG.visitors)}`},
    {label:'RPV', val: '$'+AGG.rpv, sub:'Revenue per Visitor'},
    {label:'CAC', val: USD.format(AGG.cac), sub:'Simulated'},
    {label:'LTV', val: USD.format(AGG.ltv), sub:'Simulated'},
    {label:'MRR', val: USD.format(AGG.mrr), sub:'Subscriptions est.'},
    {label:'Top City', val: 'San Francisco', sub:'by revenue'},
  ];
  grid.innerHTML = rows.map(r=>`<div class="card"><div class="kpi">${r.val}</div><div class="kpi-sub">${r.label}</div><div class="muted" style="margin-top:4px">${r.sub}</div></div>`).join('');
  byId('todayRange').textContent = todayStr();
}

/* -------------------------- Charts (Chart.js) -------------------------- */
let hourlyChart, weeklyChart, categoryChart, paymentChart, topItemsChart, regionStackedChart, monthlyChart;

function buildHourly(){
  const hours = Array.from({length:14},(_,i)=>i+8); // 08‚Üí21
  const vals = hours.map(h=>{
    if(h>=12 && h<=14) return 35000 + Math.random()*18000;           // lunch peak
    if(h>=18 && h<=20) return 42000 + Math.random()*20000;           // evening peak
    return 15000 + Math.random()*12000;
  });
  hourlyChart = new Chart(byId('hourlyChart'),{
    type:'line',
    data:{labels:hours.map(h=>`${String(h).padStart(2,'0')}:00`),datasets:[{label:'Revenue',data:vals,borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,0.18)',fill:true,tension:.3}]},
    options:{responsive:true,plugins:{legend:{display:false}}}
  });
}
function buildWeekly(){
  const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const vals = days.map((d,i)=> (i>=4? 280000: 210000) + Math.random()*80000);
  weeklyChart = new Chart(byId('weeklyChart'),{
    type:'bar',
    data:{labels:days,datasets:[{label:'Revenue',data:vals,backgroundColor:'#60a5fa'}]},
    options:{responsive:true,plugins:{legend:{display:false}}}
  });
  byId('weekTotal').textContent = 'Week Total: '+USD.format(vals.reduce((a,b)=>a+b,0));
}
function buildCategory(){
  const catAgg = {Electronics:0,Home:0,Apparel:0,Sports:0,Grocery:0};
  ORDERS.forEach(o=> o.items.forEach(i=> catAgg[i.cat]+= i.price*i.qty ));
  categoryChart = new Chart(byId('categoryChart'),{
    type:'doughnut',
    data:{labels:Object.keys(catAgg),datasets:[{data:Object.values(catAgg),backgroundColor:['#60a5fa','#7c3aed','#22c55e','#f97316','#a78bfa']}]},
    options:{plugins:{legend:{position:'bottom'}}}
  });
}
function buildPayment(){
  const pmAgg = {Card:0,'Apple Pay':0,'Google Pay':0,Cash:0};
  ORDERS.forEach(o=> pmAgg[o.pay]+=o.total );
  paymentChart = new Chart(byId('paymentChart'),{
    type:'doughnut',
    data:{labels:Object.keys(pmAgg),datasets:[{data:Object.values(pmAgg),backgroundColor:['#22c55e','#60a5fa','#a78bfa','#f59e0b']}]},
    options:{plugins:{legend:{position:'bottom'}}}
  });
}
function buildTopItems(){
  const qtyMap = {};
  ORDERS.forEach(o=> o.items.forEach(i=> qtyMap[i.name]=(qtyMap[i.name]||0)+i.qty ));
  const list = Object.entries(qtyMap).sort((a,b)=>b[1]-a[1]).slice(0,8);
  topItemsChart = new Chart(byId('topItemsChart'),{
    type:'bar',
    data:{labels:list.map(x=>x[0]),datasets:[{label:'Units',data:list.map(x=>x[1]),backgroundColor:'#f59e0b'}]},
    options:{plugins:{legend:{display:false}},scales:{x:{ticks:{maxRotation:60,minRotation:0}}}}
  });
}
function buildRegionStacked(){
  const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const series = STORES.slice(0,5); // physical stores only
  const agg = {}; series.forEach(s=> agg[s]=Array(7).fill(0));
  for(let i=0;i<7;i++){
    series.forEach((s,si)=>{ agg[s][i] = 50000 + si*12000 + i*8000 + Math.random()*18000; });
  }
  regionStackedChart = new Chart(byId('regionStackedChart'),{
    type:'bar',
    data:{ labels:days, datasets: series.map((s,idx)=>({ label:s, data:agg[s], backgroundColor:['#60a5fa','#7c3aed','#22c55e','#f97316','#e11d48'][idx%5], stack:'cities' })) },
    options:{responsive:true,plugins:{legend:{position:'bottom'}},scales:{x:{stacked:true},y:{stacked:true}}}
  });
}
function buildMonthly(){
  const months = ['Oct','Nov','Dec','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep'];
  const thisYear = months.map((_,i)=> 800000 + i*30000 + Math.random()*80000);
  const lastYear = months.map((_,i)=> 680000 + i*28000 + Math.random()*70000);
  monthlyChart = new Chart(byId('monthlyChart'),{
    type:'line',
    data:{labels:months,datasets:[
      {label:'This Year',data:thisYear,borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,0.18)',fill:true,tension:.35},
      {label:'Prev Year',data:lastYear,borderColor:'#94a3b8',borderDash:[6,6],tension:.35}
    ]},
    options:{responsive:true}
  });
}

/* -------------------------- SALES TABLE -------------------------- */
function renderOrders(){
  const body = byId('orderTable').querySelector('tbody');
  const rows = ORDERS.slice(0,220).map(b=>{
    return `<tr>
      <td>${b.order}</td><td>${b.time}</td><td>${b.store}</td><td>${b.channel}</td>
      <td>${b.qty}</td><td>${USD.format(b.subtotal)}</td><td>${USD.format(b.tax)}</td><td><strong>${USD.format(b.total)}</strong></td><td>${b.pay}</td>
    </tr>`;
  }).join('');
  body.innerHTML = rows;
  byId('orderCount').textContent = `${ORDERS.length} orders (sampled ${Math.min(220,ORDERS.length)})`;
}

/* Filters */
byId('orderSearch').addEventListener('input', e=>{
  const q = e.target.value.toLowerCase();
  const body = byId('orderTable').querySelector('tbody');
  body.innerHTML = ORDERS.filter(b=>{ const hay = JSON.stringify(b).toLowerCase(); return !q || hay.includes(q); })
    .slice(0,220).map(b=>`<tr>
    <td>${b.order}</td><td>${b.time}</td><td>${b.store}</td><td>${b.channel}</td>
    <td>${b.qty}</td><td>${USD.format(b.subtotal)}</td><td>${USD.format(b.tax)}</td><td><strong>${USD.format(b.total)}</strong></td><td>${b.pay}</td></tr>`).join('');
});
byId('orderStore').addEventListener('change', filterOrders);
byId('orderPay').addEventListener('change', filterOrders);
function filterOrders(){
  const store = byId('orderStore').value, pay = byId('orderPay').value;
  const body = byId('orderTable').querySelector('tbody');
  body.innerHTML = ORDERS.filter(b=>{ return (!store || b.store===store) && (!pay || b.pay===pay); })
    .slice(0,220).map(b=>`<tr>
    <td>${b.order}</td><td>${b.time}</td><td>${b.store}</td><td>${b.channel}</td>
    <td>${b.qty}</td><td>${USD.format(b.subtotal)}</td><td>${USD.format(b.tax)}</td><td><strong>${USD.format(b.total)}</strong></td><td>${b.pay}</td></tr>`).join('');
}
byId('exportOrders').addEventListener('click', ()=>{
  const headers = ['Order','Time','Store','Channel','Items','Subtotal','Tax','Total','Payment'];
  const rows = ORDERS.map(b=>[b.order,b.time,b.store,b.channel,b.qty,b.subtotal,b.tax,b.total,b.pay]);
  const csv = [headers.join(',')].concat(rows.map(r=>r.join(','))).join('\n');
  const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='aurelo_orders.csv'; a.click(); URL.revokeObjectURL(url);
});

/* -------------------------- DATA PACKETS (Marketplace) -------------------------- */
const PACKETS = Array.from({length: 60}, (_,i)=>{
  const cat = DP_CATS[i%DP_CATS.length];
  const fields = 8 + Math.floor(Math.random()*12);
  const rows = 50000 + Math.floor(Math.random()*900000);
  const mb = 5 + Math.floor(rows/20000) + Math.floor(Math.random()*40);
  const price = cat==='POS'? 299: cat==='E‚Äëcom'? 249: cat==='Footfall'? 199: cat==='Pricing'? 179: 159;
  const q = 75 + Math.floor(Math.random()*24);
  const dl = 50 + Math.floor(Math.random()*1200);
  const refresh = ['Hourly','Daily','Weekly'][pickWeighted([10,65,25])];
  const lic = ['Std','Pro','Enterprise'][pickWeighted([55,35,10])];
  const updated = new Date(Date.now()-Math.floor(Math.random()*10)*86400000).toLocaleDateString();
  return {name:`${cat} Packet #${i+1}`, cat, fields, rows, mb, price, q, dl, refresh, lic, updated};
});
function renderPackets(){
  const body = byId('dpTable').querySelector('tbody');
  const qmin = Number(byId('dpQmin').value||80); byId('dpQval').textContent = qmin;
  const cat = byId('dpCategory').value; const search = (byId('dpSearch').value||'').toLowerCase();
  const data = PACKETS.filter(p=> (p.q>=qmin) && (!cat || p.cat===cat) && (!search || JSON.stringify(p).toLowerCase().includes(search)));
  body.innerHTML = data.slice(0,200).map(p=>`<tr>
    <td>${p.name}</td><td>${p.cat}</td><td>${p.fields}</td><td>${fmtN(p.rows)}</td><td>${p.mb} MB</td>
    <td>${p.refresh}</td><td><span class="badge">${p.q}</span></td><td>${USD.format(p.price)}</td><td>${p.lic}</td><td>${fmtN(p.dl)}</td><td>${p.updated}</td>
  </tr>`).join('');
  // KPIs
  const k = [
    {h:'Packets', v:PACKETS.length},
    {h:'Avg Size', v:`${Math.round(PACKETS.reduce((s,p)=>s+p.mb,0)/PACKETS.length)} MB`},
    {h:'Avg Quality', v:`${Math.round(PACKETS.reduce((s,p)=>s+p.q,0)/PACKETS.length)} / 100`},
    {h:'Est. MRR', v:USD.format(PACKETS.reduce((s,p)=>s+p.price,0))}
  ];
  byId('dpKPIs').innerHTML = k.map(x=>`<div class="card"><div class="kpi">${x.v}</div><div class="kpi-sub">${x.h}</div></div>`).join('');
  // Revenue by category chart
  const agg = {}; DP_CATS.forEach(c=>agg[c]=0); PACKETS.forEach(p=> agg[p.cat]+=p.price);
  if(window.dpRevenueChart) window.dpRevenueChart.destroy();
  window.dpRevenueChart = new Chart(byId('dpRevenueChart'),{
    type:'bar', data:{labels:Object.keys(agg), datasets:[{label:'MRR', data:Object.values(agg), backgroundColor:'#7c3aed'}]}, options:{plugins:{legend:{display:false}}}
  });
}
byId('dpQmin').addEventListener('input', renderPackets);
byId('dpCategory').addEventListener('change', renderPackets);
byId('dpSearch').addEventListener('input', renderPackets);
byId('exportPackets').addEventListener('click', ()=>{
  const headers = ['Packet','Category','Fields','Rows','Size(MB)','Refresh','Quality','Price','License','Downloads','Updated'];
  const csv = [headers.join(',')].concat(PACKETS.map(p=>[p.name,p.cat,p.fields,p.rows,p.mb,p.refresh,p.q,p.price,p.lic,p.dl,p.updated].join(','))).join('\n');
  const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='aurelo_packets.csv'; a.click(); URL.revokeObjectURL(url);
});

/* -------------------------- PRODUCTS PAGE -------------------------- */
function renderProducts(){
  // 30-day performance per product
  const perf = PRODUCTS.map(p=>{
    const catBase = {Electronics:55, Home:42, Apparel:48, Sports:40, Grocery:65}[p.cat];
    const units30 = catBase + Math.floor(Math.random()*catBase*1.5);
    const gross = units30 * p.price;
    const returnPct = (p.cat==='Apparel'? (3+Math.random()*2.5) : p.cat==='Electronics'? (2+Math.random()*1.5) : (1+Math.random()*1.5)).toFixed(1);
    const rating = (4 + Math.random()).toFixed(1);
    return {...p, units30, gross, returnPct, rating};
  }).sort((a,b)=>b.gross-a.gross);

  const body = byId('productTable').querySelector('tbody');
  body.innerHTML = perf.map(p=>`<tr>
    <td>${p.sku}</td><td>${p.name}</td><td>${p.cat}</td><td>${USD.format(p.price)}</td>
    <td>${fmtN(p.units30)}</td><td>${USD.format(p.gross)}</td><td>${p.returnPct}%</td><td>${p.rating}‚òÖ</td></tr>`).join('');

  // KPIs
  const totalGross = perf.reduce((s,p)=>s+p.gross,0);
  const top = perf[0]; const elecShare = Math.round(perf.filter(p=>p.cat==='Electronics').reduce((s,p)=>s+p.gross,0)/totalGross*100);
  const skuCount = PRODUCTS.length;
  byId('productKPIs').innerHTML = `
    <div class="card"><div class="kpi">${USD.format(totalGross)}</div><div class="kpi-sub">30-Day Product Revenue</div></div>
    <div class="card"><div class="kpi">${top.name}</div><div class="kpi-sub">Top Grossing SKU</div></div>
    <div class="card"><div class="kpi">${elecShare}%</div><div class="kpi-sub">Electronics Revenue Share</div></div>`;
}

/* -------------------------- ACCOUNTS PAGE -------------------------- */
function renderAccounts(){
  const body = byId('accTable').querySelector('tbody');
  const rows = ACCOUNTS.slice(0,200).map(a=>`<tr><td>${a.acc}</td><td>${a.city}</td><td>${a.contact}</td><td>${USD.format(a.bal)}</td><td><span class="badge">${a.st}</span></td></tr>`).join('');
  body.innerHTML = rows;
  const k = [
    {h:'Accounts', v:ACCOUNTS.length},
    {h:'Open Balance', v:USD.format(ACCOUNTS.reduce((s,a)=>s+a.bal,0))},
    {h:'Overdue', v:USD.format(ACCOUNTS.filter(a=>a.st==='Overdue').reduce((s,a)=>s+a.bal,0))}
  ];
  byId('accKPIs').innerHTML = k.map(x=>`<div class="card"><div class="kpi">${x.v}</div><div class="kpi-sub">${x.h}</div></div>`).join('');
}

/* -------------------------- USERS PAGE -------------------------- */
function renderUsers(){
  const body = byId('usersTable').querySelector('tbody');
  body.innerHTML = USERS.map(u=>`<tr><td>${u.n}</td><td>${u.role}</td><td>${u.loc}</td><td>${u.active?'Yes':'No'}</td></tr>`).join('');
}

/* -------------------------- INVENTORY MANAGEMENT -------------------------- */
const SUPPLIERS = Array.from({length: 24}, (_,i)=>({
  name:`Supplier ${i+1}`,
  cat: CATEGORY[i % CATEGORY.length],
  lead: 5 + Math.floor(Math.random()*21),
  ontime: 80 + Math.floor(Math.random()*20),
  defect: (Math.random()*3.5).toFixed(1),
  moq: 20 + Math.floor(Math.random()*180),
  terms: ['Net 15','Net 30','2/10 Net 30','Prepaid'][pickWeighted([20,55,15,10])],
  priceIdx: (90 + Math.random()*25).toFixed(0),
  spend: Math.round(5000 + Math.random()*250000),
  contact: `ops@supplier${i+1}.com`
}));

function buildInventoryLines(){
  return PRODUCTS.map((p,idx)=>{
    const supplier = SUPPLIERS[idx % SUPPLIERS.length].name;
    const demand30 = 20 + Math.floor(Math.random()*250);
    const unitCost = Math.round(p.price * (0.42 + Math.random()*0.18));
    const stock = 10 + Math.floor(Math.random()*420);
    const onOrder = Math.floor(Math.random()*180);
    const back = Math.random()<0.06 ? Math.floor(Math.random()*20): 0;
    const lead = SUPPLIERS[idx % SUPPLIERS.length].lead;
    const sigma = Math.ceil(demand30*0.2);
    const daily = demand30/30;
    const safety = Math.ceil(1.65 * Math.sqrt(lead) * (sigma/30));
    const rop = Math.ceil(daily*lead + safety);
    const forecast = Math.round(demand30 * (0.98 + Math.random()*0.12));
    const eoq = Math.ceil(Math.sqrt((2* (800 + Math.random()*1200) * demand30) / Math.max(1,(unitCost*0.22))));
    const margin = Math.round(((p.price - unitCost)/p.price)*100);
    const status = stock<=0? 'Stockout' : stock<rop? 'Low' : 'Healthy';
    return { ...p, supplier, unitCost, stock, onOrder, back, lead, safety, rop, eoq, demand30, forecast, margin, status };
  });
}
const INV_LINES = buildInventoryLines();

function renderInventory(){
  const body = byId('invTable').querySelector('tbody');
  body.innerHTML = INV_LINES.map(r=>`<tr>
    <td>${r.sku}</td><td>${r.name}</td><td>${r.cat}</td>
    <td>${fmtN(r.stock)}</td><td>${fmtN(r.onOrder)}</td><td>${fmtN(r.back)}</td>
    <td>${USD.format(r.unitCost)}</td><td>${USD.format(r.price)}</td><td>${r.margin}%</td>
    <td>${fmtN(r.demand30)}</td><td>${fmtN(r.forecast)}</td>
    <td>${fmtN(r.rop)}</td><td>${fmtN(r.safety)}</td><td>${fmtN(r.eoq)}</td>
    <td>${r.lead}</td><td>${r.supplier}</td>
    <td><span class="badge" style="background:${r.status==='Healthy'?'rgba(34,197,94,.2)': r.status==='Low'?'rgba(234,179,8,.2)':'rgba(239,68,68,.2)'}">${r.status}</span></td>
  </tr>`).join('');
  // KPIs
  const k = [
    {h:'SKUs', v:INV_LINES.length},
    {h:'In-Stock %', v:`${Math.round(INV_LINES.filter(x=>x.stock>0).length/INV_LINES.length*100)}%`},
    {h:'Stockouts', v:INV_LINES.filter(x=>x.stock<=0).length},
    {h:'Avg Lead', v:`${Math.round(INV_LINES.reduce((s,x)=>s+x.lead,0)/INV_LINES.length)} d`}
  ];
  byId('invKPIs').innerHTML = k.map(x=>`<div class="card"><div class="kpi">${x.v}</div><div class="kpi-sub">${x.h}</div></div>`).join('');
  // Low stock chart by category
  const lowAgg = {}; CATEGORY.forEach(c=>lowAgg[c]=0); INV_LINES.forEach(r=>{ if(r.status!=='Healthy') lowAgg[r.cat]++; });
  if(window.invLowChart) window.invLowChart.destroy();
  window.invLowChart = new Chart(byId('invLowChart'),{ type:'bar', data:{labels:Object.keys(lowAgg), datasets:[{label:'Low/Stockout', data:Object.values(lowAgg), backgroundColor:'#ef4444'}]}, options:{plugins:{legend:{display:false}}} });
  // Days of supply distribution
  const dos = INV_LINES.map(r=> Math.max(0, Math.round(r.stock / Math.max(1,r.demand30/30))));
  const buckets = {'0-7':0,'8-14':0,'15-30':0,'31-60':0,'60+':0};
  dos.forEach(d=>{ if(d<=7) buckets['0-7']++; else if(d<=14) buckets['8-14']++; else if(d<=30) buckets['15-30']++; else if(d<=60) buckets['31-60']++; else buckets['60+']++; });
  if(window.invDOSChart) window.invDOSChart.destroy();
  window.invDOSChart = new Chart(byId('invDOSChart'),{ type:'bar', data:{labels:Object.keys(buckets), datasets:[{label:'SKU count', data:Object.values(buckets), backgroundColor:'#60a5fa'}]}, options:{plugins:{legend:{display:false}}} });
}
byId('recalcEOQ').addEventListener('click', ()=>{ INV_LINES.forEach(r=> r.eoq = Math.ceil(Math.sqrt((2*(800+Math.random()*1200)*r.demand30)/Math.max(1,(r.unitCost*0.22)))) ); renderInventory(); });
byId('exportInventory').addEventListener('click', ()=>{
  const headers = ['SKU','Name','Category','Stock','OnOrder','Backorder','UnitCost','Price','Margin','Demand30','Forecast30','ROP','Safety','EOQ','Lead','Supplier','Status'];
  const csv = [headers.join(',')].concat(INV_LINES.map(r=>[r.sku,r.name,r.cat,r.stock,r.onOrder,r.back,r.unitCost,r.price,r.margin,r.demand30,r.forecast,r.rop,r.safety,r.eoq,r.lead,r.supplier,r.status].join(','))).join('\n');
  const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='aurelo_inventory.csv'; a.click(); URL.revokeObjectURL(url);
});

/* -------------------------- SUPPLIERS -------------------------- */
function renderSuppliers(){
  const body = byId('supTable').querySelector('tbody');
  body.innerHTML = SUPPLIERS.map(s=>`<tr>
    <td>${s.name}</td><td>${s.cat}</td><td>${s.lead}</td><td>${s.ontime}%</td><td>${s.defect}%</td>
    <td>${s.moq}</td><td>${s.terms}</td><td>${s.priceIdx}</td><td>${USD.format(s.spend)}</td><td><span class="badge">${Number(s.defect)<1.5 && s.ontime>92?'Low':'Med'}</span></td><td>${s.contact}</td>
  </tr>`).join('');
  // KPIs
  const k = [
    {h:'Suppliers', v:SUPPLIERS.length},
    {h:'Avg Lead', v:`${Math.round(SUPPLIERS.reduce((s,x)=>s+x.lead,0)/SUPPLIERS.length)} d`},
    {h:'On-time ‚â• 95%', v:SUPPLIERS.filter(s=>s.ontime>=95).length},
    {h:'Spend YTD', v:USD.format(SUPPLIERS.reduce((s,x)=>s+x.spend,0))}
  ];
  byId('supKPIs').innerHTML = k.map(x=>`<div class="card"><div class="kpi">${x.v}</div><div class="kpi-sub">${x.h}</div></div>`).join('');
  // Scatter: on-time vs defect (bubble = spend index)
  const data = SUPPLIERS.map(s=>({x:s.ontime, y:Number(s.defect), r: Math.max(4, Math.round(s.spend/30000)) }));
  if(window.supScatter) window.supScatter.destroy();
  window.supScatter = new Chart(byId('supScatter'),{ type:'bubble', data:{ datasets:[{label:'Suppliers', data}] }, options:{ scales:{ x:{ title:{display:true, text:'On-time %'} }, y:{ title:{display:true, text:'Defect %'} } } } });
}

/* -------------------------- ANALYTICS -------------------------- */
byId('simPromo').addEventListener('input', e=> byId('simPromoVal').textContent = e.target.value+'%');
byId('simChurn').addEventListener('input', e=> byId('simChurnVal').textContent = e.target.value+'%');
byId('runSim').addEventListener('click', ()=>{
  const baseMRR = AGG.mrr;
  const promo = Number(byId('simPromo').value)/100;
  const churn = Number(byId('simChurn').value)/100;
  const cac = Number(byId('simCAC').value);
  const proj = Math.round(baseMRR*(1+promo)*(1-churn));
  const payback = (AGG.ltv && cac)? Math.max(1, Math.round(AGG.ltv / cac)) : '‚Äì';
  byId('simResult').textContent = `Projected MRR: ${USD.format(proj)} (Promo +${promo*100}%, Churn ‚àí${churn*100}%) ¬∑ Est. LTV: ${USD.format(AGG.ltv)} ¬∑ CAC: ${USD.format(cac)} ¬∑ Payback (orders): ${payback}`;
});
function renderInsights(){
  const list = byId('insightsList');
  const card = AGG.cardShare, apple = AGG.appleShare, conv = AGG.conversion, aov = AGG.aov;
  list.innerHTML = `
    <li>Card share <strong>${card}%</strong>, Apple Pay <strong>${apple}%</strong> ‚Äî streamline tap-to-pay lanes.</li>
    <li>Conversion <strong>${conv}%</strong> with AOV <strong>${USD.format(aov)}</strong> ‚Äî consider bundles to lift +5‚Äì10%.</li>
    <li>Online ~<strong>${Math.round(AGG.online/AGG.orders*100)}%</strong> of orders ‚Äî optimize PDP speed & mobile UX.</li>
    <li>Returns <strong>${AGG.refundRate}%</strong> ‚Äî audit sizing/description for Apparel and fragile items.</li>
  `;
}

/* -------------------------- ALERTS & SETTINGS -------------------------- */
byId('saveAlerts').addEventListener('click', ()=>{
  const msg = `Saved thresholds: returns>${byId('thReturn').value}%, card>${byId('thCard').value}%, AOV>${byId('thAOV').value}`;
  const el = document.createElement('div'); el.textContent = new Date().toLocaleTimeString()+' ‚Ä¢ '+msg;
  byId('alertLog').prepend(el);
});
byId('saveSettings').addEventListener('click', ()=>{
  localStorage.setItem('ab_pref_email', byId('prefEmail').checked?'1':'0');
  localStorage.setItem('ab_pref_light', byId('prefTheme').checked?'1':'0');
  if(byId('prefTheme').checked) document.body.classList.add('light'); else document.body.classList.remove('light');
  alert('Preferences saved');
});
byId('exportSnapshot').addEventListener('click', ()=>{
  const snap = { ts:new Date().toISOString(), agg:AGG, stores:STORES };
  const blob = new Blob([JSON.stringify(snap,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='aurelo_bay_snapshot.json'; a.click(); URL.revokeObjectURL(url);
});

/* -------------------------- Live tick (demo) -------------------------- */
setInterval(()=>{
  // Add a small order every ~20s to feel alive
  const nb = makeOrder(100000 + Math.floor(Math.random()*900000));
  ORDERS.unshift(nb); if(ORDERS.length>900) ORDERS.pop();
  // Update KPIs and hourly chart point for current hour
  const upd = aggregate(); Object.assign(AGG, upd);
  renderKPIs();
  if(hourlyChart){
    const nowH = new Date().getHours(); const label = `${String(nowH).padStart(2,'0')}:00`;
    const idx = hourlyChart.data.labels.indexOf(label);
    if(idx>=0){ hourlyChart.data.datasets[0].data[idx] += nb.total; hourlyChart.update('none'); }
  }
}, 20000);

/* -------------------------- Boot -------------------------- */
function boot(){
  renderKPIs();
  renderOrders();
  renderProducts();
  renderAccounts();
  renderUsers();
  renderPackets();
  renderInventory();
  renderSuppliers();
  buildHourly(); buildWeekly(); buildCategory(); buildPayment(); buildTopItems(); buildRegionStacked(); buildMonthly();
  renderInsights();
  byId('weekTotal').title = 'Includes in-store and online revenue';
  byId('yr').textContent = new Date().getFullYear();
}
boot();
</script>
</body>
</html>
